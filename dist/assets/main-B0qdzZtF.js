var lt=Object.defineProperty;var ct=(y,t,e)=>t in y?lt(y,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):y[t]=e;var m=(y,t,e)=>ct(y,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();const dt="modulepreload",ht=function(y){return"/"+y},it={},Q=function(t,e,a){let s=Promise.resolve();if(e&&e.length>0){let n=function(l){return Promise.all(l.map(d=>Promise.resolve(d).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),r=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=n(e.map(l=>{if(l=ht(l),l in it)return;it[l]=!0;const d=l.endsWith(".css"),c=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${c}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":dt,d||(f.as="script"),f.crossOrigin="",f.href=l,r&&f.setAttribute("nonce",r),document.head.appendChild(f),d)return new Promise((h,p)=>{f.addEventListener("load",h),f.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(n){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=n,window.dispatchEvent(o),!o.defaultPrevented)throw n}return s.then(n=>{for(const o of n||[])o.status==="rejected"&&i(o.reason);return t().catch(i)})},ut=100,gt=0,W={};class V{constructor(t={}){m(this,"baseUrl");m(this,"token");m(this,"environment");m(this,"customHeaders");m(this,"cache");m(this,"cacheTTL");this.environment=t.environment||"appdev",t.apiConfig?(this.baseUrl=t.apiConfig.url,this.customHeaders=t.apiConfig.headers||{}):(this.baseUrl=t.baseUrl||this.getDefaultUrl(this.environment),this.customHeaders=t.headers||{}),this.token=t.token||null,this.cache=new Map,this.cacheTTL=3e5}static isLocalDb(t){return t.startsWith("local:")||t.startsWith("local/")}async getTableSchema(t,e){try{const a=await this.request(`/object/${t}/tables/${e}/schema`,"GET",void 0,!0);if(a&&Array.isArray(a.columns))return a.columns;if(Array.isArray(a))return a}catch(a){console.warn("[ApiClient] Schema fetch failed",a)}return[]}getDefaultUrl(t){const e=(W==null?void 0:W.VITE_API_URL)||typeof window<"u"&&window.__API_URL__;if(e)return e;const a={appdev:"https://appdev.kbase.us/services/berdl_table_scanner",prod:"https://kbase.us/services/berdl_table_scanner",local:"http://127.0.0.1:8000"};return a[t]||a.appdev}getHeaders(){const t={"Content-Type":"application/json",Accept:"application/json",...this.customHeaders};if(this.token){const e=this.token.startsWith("Bearer ")?this.token:`Bearer ${this.token}`;t.Authorization=e}return t}getCacheKey(t,e){return`${t}:${JSON.stringify(e||{})}`}getFromCache(t){const e=this.cache.get(t);return e&&Date.now()-e.timestamp<this.cacheTTL?e.data:null}setCache(t,e){this.cache.set(t,{data:e,timestamp:Date.now()})}clearCache(){this.cache.clear()}setToken(t){this.token=t,this.clearCache()}updateConfig(t){this.baseUrl=t.url,this.customHeaders=t.headers||{},this.clearCache()}setEnvironment(t){this.environment=t,this.baseUrl=this.getDefaultUrl(t),this.clearCache()}async request(t,e,a,s=!1){const i=this.getCacheKey(t,a);if(s&&e==="GET"){const c=this.getFromCache(i);if(c)return c}if(s&&e==="POST"){const c=this.getFromCache(i);if(c)return c}const n=t.startsWith("http")?t:`${this.baseUrl}${t}`,o={method:e,headers:this.getHeaders()};let r=n;if(a)if(e==="GET"){const c=new URL(n);Object.entries(a).forEach(([f,h])=>{h!=null&&c.searchParams.set(f,String(h))}),r=c.toString()}else o.body=JSON.stringify(a);const l=await fetch(r,o);if(!l.ok){let c=`HTTP ${l.status}`,f=null;try{const p=await l.json();f=p,p.detail&&typeof p.detail=="string"&&p.detail.length>0?c=p.detail:c=p.message||p.error||p.msg||c,l.status===500&&p.detail&&p.detail.includes("shock-api")&&(c=p.detail)}catch{c=await l.text().catch(()=>"")||`${c}: ${l.statusText}`}const h=new Error(c);throw h.status=l.status,h.details=f,h}const d=await l.json();return s&&this.setCache(i,d),d}async uploadDatabase(t){const e=new FormData;e.append("file",t);const a=`${this.baseUrl}/upload`,s={Accept:"application/json",...this.customHeaders};if(this.token){const n=this.token.startsWith("Bearer ")?this.token:`Bearer ${this.token}`;s.Authorization=n}const i=await fetch(a,{method:"POST",headers:s,body:e});if(!i.ok){let n=`Upload failed: HTTP ${i.status}`;try{const o=await i.json();n=o.detail||o.message||n}catch{}throw new Error(n)}return i.json()}async listTables(t){return this.request(`/object/${t}/tables`,"GET",void 0,!0)}async testConnection(){try{return await this.request("/health","GET",void 0,!1)}catch{try{return await this.request("/","GET",void 0,!1)}catch(e){throw new Error(`Connection failed: ${e.message}`)}}}async getTableData(t){const e={...t,limit:t.limit||ut,offset:t.offset||gt,kb_env:this.environment};return this.request("/table-data","POST",e,!1)}async getSchema(t){try{return await this.request(`/schema/${t}/tables`,"GET",void 0,!0)}catch{return null}}async getTableStatistics(t,e){return this.request(`/object/${t}/tables/${e}/stats`,"GET",void 0,!0)}}const J={},Z={debug:0,info:1,warn:2,error:3};function pt(){var t;const y=(t=J==null?void 0:J.VITE_LOG_LEVEL)==null?void 0:t.toLowerCase();return y&&y in Z?y:"warn"}const mt=pt();function B(y){return Z[y]>=Z[mt]}function D(y,t){return`[${new Date().toISOString()}] [${y}] ${t}`}const $={debug(y,t){B("debug")&&(t!==void 0?console.info(D("DEBUG",y),t):console.info(D("DEBUG",y)))},info(y,t){B("info")&&(t!==void 0?console.info(D("INFO",y),t):console.info(D("INFO",y)))},warn(y,t){B("warn")&&(t!==void 0?console.warn(D("WARN",y),t):console.warn(D("WARN",y)))},error(y,t){B("error")&&(t!==void 0?console.error(D("ERROR",y),t):console.error(D("ERROR",y)))}};class rt{constructor(){m(this,"registry");m(this,"schemaMatchCache",new Map);m(this,"defaultConfigCache",null);this.registry=P.getInstance()}async resolve(t,e={}){const a=this.findStaticConfig(t,e.objectType);if(a)return{config:a,source:"static",sourceDetail:`static:${a.id}`,fromCache:!0};if(e.schema&&e.schema.tables.length>0){const i=await this.findSchemaMatch(e.schema);if(i)return{config:i.config,source:"schema_match",sourceDetail:`schema_match:${i.configId} (score: ${i.score.toFixed(2)})`,fromCache:!1,warning:`No pattern match found. Matched by schema similarity (${(i.score*100).toFixed(0)}% match).`}}const s=await this.loadDefaultConfig();return s?{config:s,source:"default",sourceDetail:"default_config",fromCache:!1,warning:`No configuration found for "${t}". Using default configuration. Consider adding a mapping in index.json.`}:($.warn(`[ConfigResolver] No config found for ${t}, using minimal fallback`),{config:this.createDefaultConfig(t),source:"default",sourceDetail:"minimal_fallback",fromCache:!1,warning:`No configuration found for "${t}". Database will be rendered with basic settings.`})}async resolveTable(t,e,a={}){var i;return((i=(await this.resolve(t,a)).config.tables)==null?void 0:i[e])??null}async resolveAndRegister(t,e={}){const a=await this.resolve(t,e);return a.config?(a.config.id||(a.config.id=this.generateConfigId(t)),this.registry.registerDataType(a.config),$.debug(`[ConfigResolver] Registered ${a.config.id} from ${a.source}`),a.config):null}hasStaticConfig(t,e){return this.findStaticConfig(t,e)!==null}async getResolutionHints(t){const e=this.hasStaticConfig(t);return{hasStaticConfig:e,recommendedSource:e?"static":"default"}}findStaticConfig(t,e){var s,i;const a=this.registry.getAppConfig();if(!(a!=null&&a.dataTypes))return null;for(const[n,o]of Object.entries(a.dataTypes))if((s=o.matches)!=null&&s.some(r=>this.matchPattern(t,r))){const r=this.registry.getDataType(n);if(r)return r}if(e){for(const[n,o]of Object.entries(a.dataTypes))if((i=o.matches)!=null&&i.some(r=>this.matchPattern(e,r))){const r=this.registry.getDataType(n);if(r)return r}}return null}matchPattern(t,e){if(e.includes("*")){const a=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");return new RegExp(`^${a}$`).test(t)}return t===e}createDefaultConfig(t){return{id:this.generateConfigId(t),name:`Auto-generated: ${t}`,version:"1.0.0",description:"Minimal configuration generated from source reference",tables:{}}}generateConfigId(t){return`auto_${t.replace(/[^a-zA-Z0-9]/g,"_")}`}async findSchemaMatch(t){const e=this.getSchemaCacheKey(t),a=this.schemaMatchCache.get(e);if(a&&Date.now()-a.timestamp<3e5){const r=this.registry.getDataType(a.configId);if(r)return{config:r,configId:a.configId,score:a.score}}const s=this.registry.getAppConfig();if(!(s!=null&&s.dataTypes))return null;let i=null;const n=new Set(t.tables.map(r=>r.toLowerCase())),o=new Map;for(const[r,l]of Object.entries(t.columns))o.set(r.toLowerCase(),new Set(l.map(d=>d.toLowerCase())));for(const[r,l]of Object.entries(s.dataTypes)){const d=l.schemaMatch;if(!(d!=null&&d.enabled))continue;const c=this.registry.getDataType(r);if(!(c!=null&&c.tables))continue;const f=d.requiredTables||[],h=d.requiredColumns||{},p=d.minMatchScore||.6;let b=0,g=0;for(const w of f)if(g++,n.has(w.toLowerCase())){b+=1;const S=h[w]||[];if(S.length>0){const k=o.get(w.toLowerCase());if(k){const x=S.filter(C=>k.has(C.toLowerCase())).length;b+=x/S.length*.5}}}if(g===0)continue;const v=b/g;v>=p&&(!i||v>i.score)&&(i={config:c,configId:r,score:v})}return i&&this.schemaMatchCache.set(e,{configId:i.configId,score:i.score,timestamp:Date.now()}),i}getSchemaCacheKey(t){const e=t.tables.sort().join(","),a=Object.entries(t.columns).sort(([s],[i])=>s.localeCompare(i)).map(([s,i])=>`${s}:${i.sort().join(",")}`).join("|");return`${e}|${a}`}async loadDefaultConfig(){var t;if(this.defaultConfigCache)return this.defaultConfigCache;try{const e=this.registry.getAppConfig(),a=((t=e==null?void 0:e.defaultConfig)==null?void 0:t.configUrl)||"/config/default-config.json",s=await fetch(a);if(s.ok){const i=await s.json();return this.defaultConfigCache=i,$.info("[ConfigResolver] Loaded default config"),i}}catch(e){$.warn("[ConfigResolver] Failed to load default config",e)}return null}}let Y=null;function G(){return Y||(Y=new rt),Y}const ft=Object.freeze(Object.defineProperty({__proto__:null,ConfigResolver:rt,getConfigResolver:G},Symbol.toStringTag,{value:"Module"})),X={pageSize:50,theme:"light",density:"default",showRowNumbers:!0,locale:"en-US",dateFormat:"YYYY-MM-DD",numberFormat:{decimals:2,thousandsSeparator:",",decimalSeparator:"."}},H={pageSize:50,density:"default",showRowNumbers:!0,enableSelection:!0,enableExport:!0,enableColumnReorder:!1,enableColumnResize:!0,defaultSortColumn:"",defaultSortOrder:"asc"},q={visible:!0,sortable:!0,filterable:!0,searchable:!0},bt={number:"right",integer:"right",float:"right",percentage:"right",currency:"right",filesize:"right",duration:"right",boolean:"center",date:"center",datetime:"center",timestamp:"center"},N=class N{constructor(){m(this,"appConfig",null);m(this,"dataTypes",new Map);m(this,"loadedUrls",new Set);m(this,"apiConfigs",new Map);m(this,"defaultApiId",null);m(this,"matchMap",new Map);m(this,"globalSettings",{...X})}static getInstance(){return N.instance||(N.instance=new N),N.instance}static reset(){N.instance=null}async initialize(t){if(this.appConfig=t,t.defaults&&(this.globalSettings={...X,...t.defaults,numberFormat:{...X.numberFormat,...t.defaults.numberFormat}}),t.apis)if(Object.values(t.apis).forEach(a=>{this.apiConfigs.set(a.id,a)}),t.apis.default)this.defaultApiId="default";else{const a=Object.keys(t.apis)[0];a&&(this.defaultApiId=a)}const e=[];for(const[a,s]of Object.entries(t.dataTypes))s.matches&&s.matches.forEach(i=>this.matchMap.set(i,a)),s.autoLoad!==!1&&e.push(this.loadDataType(a,s));await Promise.all(e)}async loadDataType(t,e){if(e.config){this.registerDataType(e.config);return}if(e.configUrl&&!this.loadedUrls.has(e.configUrl))try{const a=await fetch(e.configUrl);if(!a.ok){$.warn(`Failed to load config from ${e.configUrl}: ${a.status}`);return}const s=await a.json();this.registerDataType(s),this.loadedUrls.add(e.configUrl)}catch(a){$.error(`Error loading data type config from ${e.configUrl}`,a)}}registerDataType(t){if(!t.id){$.error("DataTypeConfig must have an id");return}t.version||($.warn(`DataTypeConfig ${t.id} missing version, defaulting to 1.0.0`),t.version="1.0.0"),this.dataTypes.set(t.id,t),$.debug(`Registered data type: ${t.id} v${t.version}`)}unregisterDataType(t){return this.dataTypes.delete(t)}getDataType(t){return this.dataTypes.get(t)}hasDataType(t){return this.dataTypes.has(t)}getAllDataTypes(){return Array.from(this.dataTypes.values())}getDataTypeIds(){return Array.from(this.dataTypes.keys())}getTableSchema(t,e){const a=this.dataTypes.get(t);if(a)return a.tables[e]}getColumnSchema(t,e,a){const s=this.getTableSchema(t,e);if(s)return s.columns.find(i=>i.column===a)}getTableNames(t){const e=this.dataTypes.get(t);return e?Object.keys(e.tables):[]}getResolvedTableConfig(t,e){var r,l,d,c,f,h,p,b,g,v,w;const a=this.dataTypes.get(t);if(!a)return null;const s=a.tables[e];if(!s)return null;const i={...H,pageSize:((r=a.defaults)==null?void 0:r.pageSize)??H.pageSize,density:((l=a.defaults)==null?void 0:l.density)??H.density,showRowNumbers:((d=a.defaults)==null?void 0:d.showRowNumbers)??H.showRowNumbers,enableSelection:((c=a.defaults)==null?void 0:c.enableSelection)??H.enableSelection,enableExport:((f=a.defaults)==null?void 0:f.enableExport)??H.enableExport,...s.settings},n=[...a.sharedCategories||[],...s.categories||[]],o=s.columns.map(S=>this.resolveColumnConfig(S));return{name:e,displayName:s.displayName||e,settings:i,categories:n,columns:o,virtualColumns:s.virtualColumns||[],rowConfig:{selectable:((h=s.rowConfig)==null?void 0:h.selectable)??!0,clickable:((p=s.rowConfig)==null?void 0:p.clickable)??!1,clickAction:((b=s.rowConfig)==null?void 0:b.clickAction)??"",heightMode:((g=s.rowConfig)==null?void 0:g.heightMode)??"auto",height:((v=s.rowConfig)==null?void 0:v.height)??"auto",conditionalStyles:((w=s.rowConfig)==null?void 0:w.conditionalStyles)??[]}}}resolveColumnConfig(t){const e=t.dataType||"string",a=bt[e]||"left";return{column:t.column,displayName:t.displayName||t.column.replace(/_/g," "),dataType:e,visible:t.visible??q.visible,sortable:t.sortable??q.sortable,filterable:t.filterable??q.filterable,searchable:t.searchable??q.searchable,copyable:t.copyable??e==="id",width:t.width||"auto",align:t.align||a,categories:t.categories||[],transform:t.transform}}getGlobalSettings(){return{...this.globalSettings}}getAppConfig(){return this.appConfig}getApiUrl(){var t,e;return((t=this.appConfig)==null?void 0:t.app.apiUrl)||this.defaultApiId&&((e=this.apiConfigs.get(this.defaultApiId))==null?void 0:e.url)||null}getApi(t){return t?this.apiConfigs.get(t):this.defaultApiId?this.apiConfigs.get(this.defaultApiId):void 0}getApis(){return Array.from(this.apiConfigs.values())}getDefaultApiId(){return this.defaultApiId}getAppName(){var t;return((t=this.appConfig)==null?void 0:t.app.name)||"DataTables Viewer"}detectDataType(t){const e=t.dataType||t.type||t.objectType||t.object_type;if(!e)return null;if(this.hasDataType(e))return e;if(this.matchMap.has(e))return this.matchMap.get(e)??null;const a=e.toLowerCase().replace(/[^a-z0-9]/g,"_");if(this.hasDataType(a))return a;const s=this.getDataTypeIds()[0];return s?($.warn(`Unknown data type "${e}", falling back to "${s}"`),s):null}static fromLegacyConfig(t){var a,s,i;const e={};if(t.tables)for(const[n,o]of Object.entries(t.tables))e[n]={displayName:o.name||n,categories:o.categories||[],columns:(o.columns||[]).map(r=>({column:r.column,displayName:r.displayName,dataType:r.dataType||"string",visible:r.visible,sortable:r.sortable,filterable:r.filterable,width:r.width,categories:r.categories,transform:r.transform})),settings:o.settings};return{id:"legacy",name:t.name||"Legacy Config",version:"1.0.0",description:t.description,defaults:{pageSize:(a=t.defaultSettings)==null?void 0:a.pageSize,density:(s=t.defaultSettings)==null?void 0:s.density,showRowNumbers:(i=t.defaultSettings)==null?void 0:i.showRowNumbers},tables:e}}async resolveAndRegister(t,e){const s=await G().resolve(t,e);return s.config?(s.config.id||(s.config.id=`auto_${t.replace(/[^a-zA-Z0-9]/g,"_")}`),this.registerDataType(s.config),$.debug(`[DataTypeRegistry] Registered ${s.config.id} from ${s.source}`),s.config):null}isRemoteConfigEnabled(){return!1}getConfigApiSettings(){return null}setAuthToken(t){}async resolveConfig(t,e){return G().resolve(t,e)}async hasConfigFor(t,e){var s;const a=this.getAppConfig();if(a!=null&&a.dataTypes){for(const[i,n]of Object.entries(a.dataTypes))if((s=n.matches)!=null&&s.some(o=>this.matchPattern(t,o)))return{hasConfig:!0,source:"static"}}return{hasConfig:!1,source:"none"}}matchPattern(t,e){if(e.includes("*")){const a=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");return new RegExp(`^${a}$`).test(t)}return t===e}};m(N,"instance",null);let P=N;class nt{constructor(t){m(this,"registry");m(this,"legacyConfig",null);m(this,"currentDataTypeId",null);m(this,"isLegacyMode",!1);this.registry=P.getInstance(),t&&(this.isNewConfigFormat(t)?this.initializeFromAppConfig(t):this.initializeFromLegacyConfig(t))}isNewConfigFormat(t){var e;return t&&(t.dataTypes||((e=t.app)==null?void 0:e.name))}initializeFromAppConfig(t){this.isLegacyMode=!1,Object.entries(t.dataTypes||{}).forEach(([e,a])=>{a.config&&(this.registry.registerDataType(a.config),this.currentDataTypeId||(this.currentDataTypeId=e))})}initializeFromLegacyConfig(t){this.isLegacyMode=!0,this.legacyConfig=t;const e=P.fromLegacyConfig(t);this.registry.registerDataType(e),this.currentDataTypeId="legacy"}async initializeAsync(t){if(t)try{const e=await fetch(t);if(!e.ok){console.warn(`Failed to load config from ${t}`);return}const a=await e.json();if(this.isNewConfigFormat(a)){await this.registry.initialize(a);const s=this.registry.getDataTypeIds();s.length>0&&(this.currentDataTypeId=s[0])}else this.initializeFromLegacyConfig(a)}catch(e){console.error("Error loading configuration:",e)}}setCurrentDataType(t){if(this.registry.hasDataType(t))return this.currentDataTypeId=t,!0;const e=this.registry.detectDataType({dataType:t});return e?(this.currentDataTypeId=e,!0):($.warn(`Data type "${t}" not found in registry`),!1)}getCurrentDataTypeId(){return this.currentDataTypeId}getCurrentDataType(){if(this.currentDataTypeId)return this.registry.getDataType(this.currentDataTypeId)}detectDataType(t){const e=this.registry.detectDataType(t);return e&&(this.currentDataTypeId=e),e}getTableConfig(t){var e,a;if(this.currentDataTypeId){const s=this.registry.getResolvedTableConfig(this.currentDataTypeId,t);if(s)return this.convertResolvedToLegacy(s)}if((a=(e=this.legacyConfig)==null?void 0:e.tables)!=null&&a[t]){const s=this.legacyConfig.tables[t];return{name:s.name||t,categories:s.categories||[],columns:s.columns||[],settings:{...this.legacyConfig.defaultSettings,...s.settings||{}}}}return{name:t,categories:[],columns:[],settings:this.getGlobalSettings()}}getTableSchema(t){if(this.currentDataTypeId)return this.registry.getTableSchema(this.currentDataTypeId,t)}getResolvedTableConfig(t){return this.currentDataTypeId?this.registry.getResolvedTableConfig(this.currentDataTypeId,t):null}hasTableConfig(t){var e;return this.currentDataTypeId&&this.registry.getTableSchema(this.currentDataTypeId,t)?!0:!!((e=this.legacyConfig)!=null&&e.tables&&Object.prototype.hasOwnProperty.call(this.legacyConfig.tables,t))}getTableNames(){var t;return this.currentDataTypeId?this.registry.getTableNames(this.currentDataTypeId):(t=this.legacyConfig)!=null&&t.tables?Object.keys(this.legacyConfig.tables):[]}getAppName(){var t;return this.registry.getAppName()||((t=this.legacyConfig)==null?void 0:t.name)||"DataTables Viewer"}getApi(t){return this.registry.getApi(t)}getApis(){return this.registry.getApis()}getDefaultApiId(){return this.registry.getDefaultApiId()}getApiUrl(){var t;return this.registry.getApiUrl()||((t=this.legacyConfig)==null?void 0:t.apiUrl)||null}getEnvironment(){var e;const t=this.registry.getAppConfig();return(t==null?void 0:t.app.environment)||((e=this.legacyConfig)==null?void 0:e.environment)||"local"}getGlobalSettings(){var a;const t=this.registry.getGlobalSettings(),e=((a=this.legacyConfig)==null?void 0:a.defaultSettings)||{};return{...t,...e}}convertResolvedToLegacy(t){return{name:t.displayName,categories:t.categories.map(e=>({id:e.id,name:e.name,icon:e.icon,color:e.color,description:e.description,defaultVisible:e.defaultVisible})),columns:t.columns.map(e=>({column:e.column,displayName:e.displayName,description:e.description,width:e.width,visible:e.visible,sortable:e.sortable,filterable:e.filterable,categories:e.categories,transform:Array.isArray(e.transform)?{type:"chain",options:{transforms:e.transform}}:e.transform})),settings:{pageSize:t.settings.pageSize,density:t.settings.density,showRowNumbers:t.settings.showRowNumbers,enableSelection:t.settings.enableSelection,enableExport:t.settings.enableExport}}}getRegistry(){return this.registry}isLegacy(){return this.isLegacyMode}async resolveConfig(t,e){const s=await G().resolve(t,e);return s.config&&(this.registry.hasDataType(s.config.id)||this.registry.registerDataType(s.config),this.currentDataTypeId=s.config.id),s}isRemoteEnabled(){return!1}setAuthToken(t){}}const ot={berdlTableId:null,activeTableName:null,availableTables:[],headers:[],columns:[],visibleColumns:new Set,data:[],totalCount:0,filteredCount:0,currentPage:0,pageSize:50,sortColumn:null,sortDirection:"asc",sortOrder:"asc",columnFilters:{},advancedFilters:void 0,aggregations:void 0,groupBy:void 0,searchQuery:"",searchValue:"",selectedRows:new Set,loading:!1,error:null,theme:"light",density:"normal",showRowNumbers:!0,queryCached:!1,queryTime:void 0};class yt{constructor(t={}){m(this,"state");m(this,"listeners");this.state={...ot,...t},this.listeners=new Set}getState(){return{...this.state}}update(t){t.sortDirection&&!t.sortOrder?t.sortOrder=t.sortDirection:t.sortOrder&&!t.sortDirection&&(t.sortDirection=t.sortOrder),t.searchQuery!==void 0&&t.searchValue===void 0?t.searchValue=t.searchQuery:t.searchValue!==void 0&&t.searchQuery===void 0&&(t.searchQuery=t.searchValue),this.state={...this.state,...t},this.notify()}reset(){this.state={...ot},this.notify()}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t(this.state))}}class vt{constructor(t){m(this,"categories");m(this,"columnsByCategory");m(this,"initialVisibleCategories");m(this,"uncategorizedColumns");this.categories=new Map,this.columnsByCategory=new Map,this.initialVisibleCategories=new Set,this.uncategorizedColumns=new Set,this.initialize(t)}initialize(t){(t.categories||[]).forEach(a=>{this.categories.set(a.id,a),this.columnsByCategory.set(a.id,new Set),a.defaultVisible!==!1&&this.initialVisibleCategories.add(a.id)}),t.columns&&this.setColumns(t.columns)}setColumns(t){this.uncategorizedColumns.clear(),this.categories.forEach((e,a)=>{var s;return(s=this.columnsByCategory.get(a))==null?void 0:s.clear()}),t.forEach(e=>{const a=e.column;let s=!1;e.categories&&Array.isArray(e.categories)&&e.categories.length>0&&e.categories.forEach(i=>{var n;this.categories.has(i)&&((n=this.columnsByCategory.get(i))==null||n.add(a),s=!0)}),s||this.uncategorizedColumns.add(a)})}getInitialVisibleColumns(){const t=new Set;return this.initialVisibleCategories.forEach(e=>{const a=this.columnsByCategory.get(e);a&&a.forEach(s=>t.add(s))}),this.uncategorizedColumns.forEach(e=>t.add(e)),t}getColumnsForCategory(t){return this.columnsByCategory.get(t)||new Set}calculateVisibilityChange(t,e){const a=this.columnsByCategory.get(t);if(!a||a.size===0)return new Set(e);const s=new Set(e),i=Array.from(a);return i.every(o=>e.has(o))?i.forEach(o=>s.delete(o)):i.forEach(o=>s.add(o)),s}getAllCategories(t){return Array.from(this.categories.values()).map(e=>{const a=this.columnsByCategory.get(e.id),s=(a==null?void 0:a.size)||0,i=s>0&&Array.from(a||[]).every(n=>t.has(n));return{...e,visible:i,columnCount:s}})}getColumnsByCategory(){const t=new Map;return this.columnsByCategory.forEach((e,a)=>{t.set(a,Array.from(e))}),t}getUncategorizedColumns(){return Array.from(this.uncategorizedColumns)}}class st{constructor(t){m(this,"container");m(this,"id");m(this,"dom",{});this.container=t.container,this.id=t.id||`cmp-${Math.random().toString(36).substr(2,9)}`}mount(){this.render(),this.bindEvents()}destroy(){this.container.innerHTML="",this.dom={}}cacheDom(t){this.dom={};for(const[e,a]of Object.entries(t)){const s=this.container.querySelector(a);s&&(this.dom[e]=s)}}}class wt extends st{constructor(e){super(e);m(this,"configManager");m(this,"stateManager");m(this,"categoryManager",null);m(this,"options");m(this,"expandedCategories",new Set);this.configManager=e.configManager,this.stateManager=e.stateManager,this.options=e,this.stateManager.subscribe(a=>{this.dom.loadBtn&&(this.dom.loadBtn.innerHTML=a.loading?'<span class="ts-spinner"></span> Loading...':'<i class="bi bi-lightning-charge-fill"></i> Load Data',this.dom.loadBtn.disabled=a.loading),this.updateLoadingState(a),!a.loading&&a.availableTables.length>0&&a.data.length>0&&a.activeTableName&&setTimeout(()=>{this.dom.sourceBody&&this.dom.sourceBody.style.display!=="none"&&(this.dom.sourceBody.style.display="none",this.dom.sourceArrow.classList.add("collapsed"))},500),a.activeTableName&&a.availableTables.length>0&&this.updateTableInfo(a.activeTableName),a.columns.length>0&&this.dom.controlList&&this.renderControlList(),this.renderFilterChips(),this.updateAggregationsDisplay(a)})}get onLoadData(){return this.options.onLoadData}updateAggregationsDisplay(e){var i,n;if(!this.dom.aggregationsSection||!this.dom.aggregationsInfo)return;const a=e.aggregations&&e.aggregations.length>0,s=e.groupBy&&e.groupBy.length>0;if(a||s){this.dom.aggregationsSection.style.display="block";const o=((i=e.aggregations)==null?void 0:i.map(l=>`${l.function.toUpperCase()}(${l.column})`).join(", "))||"None",r=((n=e.groupBy)==null?void 0:n.join(", "))||"None";this.dom.aggregationsInfo.innerHTML=`
                <div style="margin-bottom:4px"><strong>Functions:</strong> ${o}</div>
                <div><strong>Group By:</strong> ${r}</div>
            `}else this.dom.aggregationsSection.style.display="none"}setCategoryManager(e){this.categoryManager=e,this.renderControlList(),this.expandColumnsSection()}expandColumnsSection(){this.dom.controlSection&&(this.dom.controlSection.style.display="block")}collapseColumnsSection(){this.dom.controlSection&&(this.dom.controlSection.style.display="none")}render(){const e=this.configManager.getAppName()||"DataTables Viewer";this.container.innerHTML=`
            <header class="ts-sidebar-header">
                <div class="ts-brand">
                    <div class="ts-brand-icon"><i class="bi bi-grid-3x3-gap-fill"></i></div>
                    <span class="ts-brand-name">${e}</span>
                </div>
            </header>

            <div class="ts-sidebar-body">
                <!-- Connection -->
                <section class="ts-section" id="ts-source-section" style="padding: 0 4px;">
                    <div class="ts-section-header collapsible" id="ts-source-head">
                        <span class="ts-section-title">Data Source</span>
                        <div style="display:flex; align-items:center; gap:8px">
                            <i class="bi bi-chevron-down ts-section-arrow" id="ts-source-arrow"></i>
                            <i class="bi bi-database-fill-gear ts-text-muted"></i>
                        </div>
                    </div>
                    <div id="ts-source-body">
                        <div class="ts-field">
                            <label class="ts-label">Auth Token <span style="color:red">*</span></label>
                            <input type="password" class="ts-input" id="ts-token" placeholder="Enter KBase token...">
                        </div>
                        <div class="ts-field">
                            <label class="ts-label">Object ID / UPA</label>
                            <input type="text" class="ts-input" id="ts-berdl" 
                                placeholder="e.g., 76990/7/2" value="76990/7/2">
                        </div>
                        <button class="ts-btn-primary" id="ts-load" style="height: 34px; width: 100%;">
                            <i class="bi bi-lightning-charge-fill"></i> Load Data
                        </button>
                        <div style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
                            <div style="height: 1px; background: var(--c-border-subtle); flex: 1;"></div>
                            <span style="font-size: 11px; color: var(--c-text-muted); text-transform: uppercase;">OR</span>
                            <div style="height: 1px; background: var(--c-border-subtle); flex: 1;"></div>
                        </div>
                        <div class="ts-field" style="margin-top: 12px;">
                            <label class="ts-label">Upload SQLite Database</label>
                            <input type="file" class="ts-input" id="ts-upload-db-file" accept=".db,.sqlite,.sqlite3" style="display:none">
                            <button class="ts-btn-secondary" id="ts-upload-db" style="height: 34px; width: 100%;">
                                <i class="bi bi-upload"></i> Upload Database
                            </button>
                            <div id="ts-upload-info" style="margin-top:8px;font-size:12px;color:var(--c-text-muted);display:none"></div>
                        </div>
                        <div id="ts-loading-indicator" style="display:none;margin-top:12px;padding:12px;background:var(--c-bg-surface);border-radius:var(--radius-sm);border:1px solid var(--c-border-subtle)">
                            <div style="display:flex;align-items:center;gap:10px;color:var(--c-text-secondary);font-size:13px">
                                <span class="ts-spinner" style="width:16px;height:16px"></span>
                                <span id="ts-loading-text">Loading data...</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Table Selection -->
                <section class="ts-section" id="ts-nav-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Active Table</span>
                    </div>
                    <select class="ts-select" id="ts-table-select"></select>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
                        <button class="ts-btn-secondary" id="ts-view-schema">
                            <i class="bi bi-file-earmark-code"></i> Schema
                        </button>
                        <button class="ts-btn-secondary" id="ts-view-stats">
                            <i class="bi bi-graph-up"></i> Stats
                        </button>
                    </div>
                </section>

                <!-- Data Control (Unified Categories & Columns) -->
                <section class="ts-section" id="ts-control-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Data Control</span>
                        <div class="ts-section-actions">
                            <button class="ts-section-action" id="ts-control-expand-all">Expand All</button>
                            <button class="ts-section-action" id="ts-control-show-all">Show All</button>
                        </div>
                    </div>
                    <div class="ts-control-list" id="ts-control-list"></div>
                </section>

                <!-- Active Filters -->
                <section class="ts-section" id="ts-filters-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Active Filters</span>
                        <div style="display:flex;gap:4px">
                            <button class="ts-section-action" id="ts-advanced-filters" title="Advanced Filters">
                                <i class="bi bi-funnel-fill"></i> Advanced
                            </button>
                            <button class="ts-section-action" id="ts-clear-filters">Clear All</button>
                        </div>
                    </div>
                    <div class="ts-filter-chips" id="ts-filter-chips"></div>
                </section>
                
                <!-- Aggregations -->
                <section class="ts-section" id="ts-aggregations-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Aggregations</span>
                        <button class="ts-section-action" id="ts-aggregations-btn">
                            <i class="bi bi-calculator"></i> Configure
                        </button>
                    </div>
                    <div id="ts-aggregations-info" style="padding:8px;font-size:12px;color:var(--c-text-muted)">
                        No aggregations configured
                    </div>
                </section>
            </div>

            <footer class="ts-sidebar-footer">
                <div class="ts-btn-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="ts-btn-secondary" id="ts-export">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="ts-btn-secondary" id="ts-reset">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                </div>
            </footer>
        `,this.cacheDom({token:"#ts-token",berdl:"#ts-berdl",loadBtn:"#ts-load",sourceHead:"#ts-source-head",sourceBody:"#ts-source-body",sourceArrow:"#ts-source-arrow",loadingIndicator:"#ts-loading-indicator",loadingText:"#ts-loading-text",navSection:"#ts-nav-section",tableSelect:"#ts-table-select",viewSchema:"#ts-view-schema",viewStats:"#ts-view-stats",controlSection:"#ts-control-section",controlList:"#ts-control-list",controlExpandAll:"#ts-control-expand-all",controlShowAll:"#ts-control-show-all",filtersSection:"#ts-filters-section",filterChips:"#ts-filter-chips",clearFilters:"#ts-clear-filters",advancedFilters:"#ts-advanced-filters",aggregationsSection:"#ts-aggregations-section",aggregationsBtn:"#ts-aggregations-btn",aggregationsInfo:"#ts-aggregations-info",export:"#ts-export",reset:"#ts-reset",uploadDbFile:"#ts-upload-db-file",uploadDbBtn:"#ts-upload-db",uploadInfo:"#ts-upload-info"})}bindEvents(){var e,a,s,i,n,o,r,l,d,c,f;(e=this.dom.loadBtn)==null||e.addEventListener("click",()=>{this.dom.sourceBody&&(this.dom.sourceBody.style.display="block",this.dom.sourceArrow.classList.remove("collapsed")),this.options.onLoadData()}),(a=this.dom.sourceHead)==null||a.addEventListener("click",()=>{const h=this.dom.sourceBody.style.display==="none";this.dom.sourceBody.style.display=h?"block":"none",this.dom.sourceArrow.classList.toggle("collapsed",!h)}),(s=this.dom.berdl)==null||s.addEventListener("keypress",h=>{h.key==="Enter"&&this.dom.loadBtn.click()}),(i=this.dom.uploadDbBtn)==null||i.addEventListener("click",()=>{var h;(h=this.dom.uploadDbFile)==null||h.click()}),(n=this.dom.uploadDbFile)==null||n.addEventListener("change",h=>{var g;const p=h.target,b=(g=p.files)==null?void 0:g[0];b&&(this.dom.uploadInfo&&(this.dom.uploadInfo.textContent=`Selected: ${b.name} (${(b.size/1024/1024).toFixed(2)} MB)`,this.dom.uploadInfo.style.display="block"),this.options.onUploadDb&&this.options.onUploadDb(b),p.value="")}),(o=this.dom.tableSelect)==null||o.addEventListener("change",h=>{this.options.onTableChange(h.target.value)}),(r=this.dom.export)==null||r.addEventListener("click",()=>this.options.onExport()),(l=this.dom.reset)==null||l.addEventListener("click",()=>this.options.onReset()),(d=this.dom.controlList)==null||d.addEventListener("click",h=>{const p=h.target;if(p.closest(".ts-switch")){const b=p.closest(".ts-cat-group"),g=b==null?void 0:b.dataset.cat;if(g&&this.categoryManager){const v=this.stateManager.getState().visibleColumns,w=this.categoryManager.calculateVisibilityChange(g,v);this.stateManager.update({visibleColumns:w})}return}if(p.closest(".ts-cat-head")){const b=p.closest(".ts-cat-group"),g=b==null?void 0:b.dataset.cat;g&&(this.expandedCategories.has(g)?this.expandedCategories.delete(g):this.expandedCategories.add(g),b==null||b.classList.toggle("expanded"));return}if(p.matches('input[type="checkbox"]')){const b=p.dataset.col;if(b){const g=this.stateManager.getState();p.checked?g.visibleColumns.add(b):g.visibleColumns.delete(b),this.stateManager.update({visibleColumns:g.visibleColumns})}}}),(c=this.dom.controlExpandAll)==null||c.addEventListener("click",()=>{const h=this.dom.controlList.querySelectorAll(".ts-cat-group"),p=Array.from(h).some(b=>!b.classList.contains("expanded"));h.forEach(b=>{const g=b.dataset.cat;p?(b.classList.add("expanded"),g&&this.expandedCategories.add(g)):(b.classList.remove("expanded"),g&&this.expandedCategories.delete(g))}),this.dom.controlExpandAll.textContent=p?"Collapse All":"Expand All"}),(f=this.dom.controlShowAll)==null||f.addEventListener("click",()=>{this.toggleAllColumns()}),this.dom.viewSchema&&this.dom.viewSchema.addEventListener("click",()=>{const h=this.stateManager.getState();if(h.activeTableName)this.options.onShowSchema(h.activeTableName);else{const p=this.dom.tableSelect;p!=null&&p.value&&this.options.onShowSchema(p.value)}}),this.dom.viewStats&&this.dom.viewStats.addEventListener("click",()=>{const h=this.stateManager.getState();if(h.activeTableName)this.options.onShowStats(h.activeTableName);else{const p=this.dom.tableSelect;p!=null&&p.value&&this.options.onShowStats(p.value)}}),this.dom.clearFilters&&this.dom.clearFilters.addEventListener("click",()=>{this.stateManager.update({columnFilters:{},advancedFilters:void 0,currentPage:0})}),this.dom.advancedFilters&&this.dom.advancedFilters.addEventListener("click",()=>{this.showAdvancedFilterPanel()}),this.dom.aggregationsBtn&&this.dom.aggregationsBtn.addEventListener("click",()=>{this.showAggregationsPanel()})}showAdvancedFilterPanel(){const e=this.stateManager.getState(),a=e.columns.map(i=>({column:i.column,displayName:i.displayName||i.column,type:i.dataType||"TEXT"})),s=document.createElement("div");s.className="ts-modal-overlay show",s.innerHTML=`
            <div class="ts-modal" style="max-width:600px">
                <div class="ts-modal-header">
                    <h3>Advanced Filters</h3>
                    <button class="ts-modal-close"><i class="bi bi-x"></i></button>
                </div>
                <div class="ts-modal-body" id="ts-advanced-filter-container"></div>
            </div>
        `,document.body.appendChild(s),Q(async()=>{const{AdvancedFilterPanel:i}=await import("./AdvancedFilterPanel-D4yVTGXP.js");return{AdvancedFilterPanel:i}},[]).then(({AdvancedFilterPanel:i})=>{var r;const n=s.querySelector("#ts-advanced-filter-container");if(!n)return;const o=new i({container:n,columns:a,onApply:l=>{this.stateManager.update({advancedFilters:l,currentPage:0}),document.body.removeChild(s),this.options.onLoadData()},onCancel:()=>{document.body.removeChild(s)}});e.advancedFilters&&o.setFilters(e.advancedFilters),(r=s.querySelector(".ts-modal-close"))==null||r.addEventListener("click",()=>{document.body.removeChild(s)}),o.mount()})}showAggregationsPanel(){var l,d,c,f;const e=this.stateManager.getState(),a=e.columns.map(h=>({column:h.column,displayName:h.displayName||h.column,type:h.dataType||"TEXT"})),s=document.createElement("div");s.className="ts-modal-overlay show",s.innerHTML=`
            <div class="ts-modal" style="max-width:600px">
                <div class="ts-modal-header">
                    <h3>Configure Aggregations</h3>
                    <button class="ts-modal-close"><i class="bi bi-x"></i></button>
                </div>
                <div class="ts-modal-body">
                    <div style="margin-bottom:16px">
                        <label style="display:block;margin-bottom:8px;font-weight:500">Group By Columns</label>
                        <select multiple class="ts-select" id="ts-group-by" style="min-height:100px">
                            ${a.map(h=>`<option value="${h.column}">${h.displayName||h.column}</option>`).join("")}
                        </select>
                        <small style="color:var(--c-text-muted)">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div id="ts-aggregations-list"></div>
                    <button class="ts-btn-secondary" id="ts-add-aggregation" style="margin-top:12px">
                        <i class="bi bi-plus"></i> Add Aggregation
                    </button>
                </div>
                <div class="ts-modal-footer">
                    <button class="ts-btn-secondary" id="ts-agg-cancel">Cancel</button>
                    <button class="ts-btn-primary" id="ts-agg-apply">Apply</button>
                </div>
            </div>
        `,document.body.appendChild(s);const i=e.aggregations||[],n=e.groupBy||[],o=()=>{const h=s.querySelector("#ts-aggregations-list");if(h){if(i.length===0){h.innerHTML='<p style="color:var(--c-text-muted);font-size:13px">No aggregations. Click "Add Aggregation" to create one.</p>';return}h.innerHTML=i.map((p,b)=>`
                <div class="ts-agg-item" style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-bottom:8px;padding:12px;background:var(--c-bg-surface-alt);border-radius:var(--radius-sm)">
                    <select class="ts-select" data-agg-col="${b}">
                        ${a.map(g=>`<option value="${g.column}" ${p.column===g.column?"selected":""}>${g.displayName||g.column}</option>`).join("")}
                    </select>
                    <select class="ts-select" data-agg-func="${b}">
                        <option value="count" ${p.function==="count"?"selected":""}>Count</option>
                        <option value="sum" ${p.function==="sum"?"selected":""}>Sum</option>
                        <option value="avg" ${p.function==="avg"?"selected":""}>Average</option>
                        <option value="min" ${p.function==="min"?"selected":""}>Min</option>
                        <option value="max" ${p.function==="max"?"selected":""}>Max</option>
                        <option value="stddev" ${p.function==="stddev"?"selected":""}>StdDev</option>
                        <option value="variance" ${p.function==="variance"?"selected":""}>Variance</option>
                        <option value="distinct_count" ${p.function==="distinct_count"?"selected":""}>Distinct Count</option>
                    </select>
                    <button class="ts-btn-secondary" data-agg-remove="${b}" style="padding:8px">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join(""),h.querySelectorAll("[data-agg-col]").forEach(p=>{p.addEventListener("change",b=>{const g=parseInt(b.target.dataset.aggCol||"0");i[g].column=b.target.value})}),h.querySelectorAll("[data-agg-func]").forEach(p=>{p.addEventListener("change",b=>{const g=parseInt(b.target.dataset.aggFunc||"0");i[g].function=b.target.value})}),h.querySelectorAll("[data-agg-remove]").forEach(p=>{p.addEventListener("click",b=>{const g=parseInt(b.target.dataset.aggRemove||"0");i.splice(g,1),o()})})}};(l=s.querySelector("#ts-add-aggregation"))==null||l.addEventListener("click",()=>{var h;i.push({column:((h=a[0])==null?void 0:h.column)||"",function:"count"}),o()}),(d=s.querySelector("#ts-agg-apply"))==null||d.addEventListener("click",()=>{const h=s.querySelector("#ts-group-by"),p=Array.from(h.selectedOptions).map(b=>b.value);this.stateManager.update({aggregations:i.length>0?i:void 0,groupBy:p.length>0?p:void 0,currentPage:0}),document.body.removeChild(s),this.options.onLoadData&&this.options.onLoadData()}),(c=s.querySelector("#ts-agg-cancel"))==null||c.addEventListener("click",()=>{document.body.removeChild(s)}),(f=s.querySelector(".ts-modal-close"))==null||f.addEventListener("click",()=>{document.body.removeChild(s)}),o();const r=s.querySelector("#ts-group-by");n&&Array.from(r.options).forEach(h=>{h.selected=n.includes(h.value)})}updateTables(e){this.dom.navSection&&(e.length>0?(this.dom.navSection.style.display="block",this.dom.tableSelect.innerHTML="",e.forEach(a=>{const s=document.createElement("option");s.value=a.name;const i=a.row_count??a.count,n=typeof i=="number"?i.toLocaleString():"?";s.textContent=`${a.displayName||a.name} (${n} rows)`,this.dom.tableSelect.appendChild(s)})):this.dom.navSection.style.display="none")}updateTableInfo(e){this.dom.tableSelect&&this.dom.tableSelect.value!==e&&(this.dom.tableSelect.value=e)}renderControlList(){if(!this.dom.controlList)return;this.dom.controlSection.style.display="block";const e=this.stateManager.getState(),a=this.categoryManager?this.categoryManager.getAllCategories(e.visibleColumns):[],s=this.categoryManager?this.categoryManager.getColumnsByCategory():new Map,i=this.categoryManager?this.categoryManager.getUncategorizedColumns():e.columns.map(r=>r.column);let n="";a.forEach(r=>{const l=s.get(r.id)||[];l.length!==0&&(n+=this.renderCategoryGroup(r,l,e))}),i.length>0&&(n+=this.renderCategoryGroup({id:"other",name:"Other Attributes",icon:"bi-three-dots",color:"#64748b",visible:!0},i,e,!0)),this.dom.controlList.innerHTML=n;const o=e.columns.every(r=>e.visibleColumns.has(r.column));this.dom.controlShowAll&&(this.dom.controlShowAll.textContent=o?"Hide All":"Show All")}renderCategoryGroup(e,a,s,i=!1){const n=s.columns.reduce((r,l)=>(r[l.column]=l,r),{});return`
            <div class="ts-cat-group ${this.expandedCategories.has(e.id)?"expanded":""}" data-cat="${e.id}">
                <div class="ts-cat-head">
                    <div class="ts-cat-info">
                        <i class="bi bi-chevron-down ts-cat-arrow"></i>
                        <i class="${e.icon||"bi bi-folder-fill"}" style="color:${e.color||"var(--c-accent)"}"></i>
                        <span class="ts-cat-name">${e.name}</span>
                        <span class="ts-cat-count">${a.length}</span>
                    </div>
                    ${i?"":`<div class="ts-switch ${e.visible?"on":""}"></div>`}
                </div>
                <div class="ts-cat-cols">
                    ${a.map(r=>{const l=n[r]||{displayName:r};return`
                            <label class="ts-col-item">
                                <input type="checkbox" data-col="${r}" ${s.visibleColumns.has(r)?"checked":""}>
                                <span>${l.displayName||r}</span>
                            </label>
                        `}).join("")}
                </div>
            </div>
        `}renderFilterChips(){const e=this.stateManager.getState(),a=e.columnFilters,s=e.advancedFilters,i=Object.keys(a).length>0||s&&s.length>0;if(this.dom.filtersSection&&(this.dom.filtersSection.style.display=i?"block":"none"),!this.dom.filterChips)return;const n=[],o=new Set((s||[]).map(r=>r.column));Object.entries(a).forEach(([r,l])=>{o.has(r)||n.push(`
                    <div class="ts-chip">
                        <span class="ts-chip-label">${r}:</span>
                        <span class="ts-chip-value">${l}</span>
                        <button class="ts-chip-clear" data-col="${r}"><i class="bi bi-x"></i></button>
                    </div>
                `)}),s&&s.length>0&&s.forEach((r,l)=>{const d=this.getOperatorLabel(r.operator),c=r.operator==="between"?`${r.value} - ${r.value2}`:r.operator==="in"||r.operator==="not_in"?Array.isArray(r.value)?r.value.join(", "):String(r.value):r.operator==="is_null"||r.operator==="is_not_null"?"":String(r.value||"");n.push(`
                    <div class="ts-chip ts-chip-advanced">
                        <span class="ts-chip-label">${r.column} ${d}:</span>
                        <span class="ts-chip-value">${c}</span>
                        <button class="ts-chip-clear" data-adv-filter="${l}"><i class="bi bi-x"></i></button>
                    </div>
                `)}),this.dom.filterChips.innerHTML=n.join(""),this.dom.filterChips.querySelectorAll(".ts-chip-clear").forEach(r=>{r.addEventListener("click",l=>{var f;const d=l.currentTarget.dataset.col,c=l.currentTarget.dataset.advFilter;if(d){const h={...this.stateManager.getState().columnFilters};delete h[d],this.stateManager.update({columnFilters:h,currentPage:0})}else if(c!==void 0){const h=this.stateManager.getState(),p=(f=h.advancedFilters)==null?void 0:f[parseInt(c)],b=[...h.advancedFilters||[]];b.splice(parseInt(c),1);const g={...h.columnFilters};p!=null&&p.column&&delete g[p.column],this.stateManager.update({columnFilters:g,advancedFilters:b.length>0?b:void 0,currentPage:0})}})})}getOperatorLabel(e){return{eq:"=",ne:"!=",gt:">",gte:">=",lt:"<",lte:"<=",like:"contains",ilike:"contains (i)",in:"in",not_in:"not in",between:"between",is_null:"is null",is_not_null:"is not null",regex:"regex"}[e]||e}toggleAllColumns(){const e=this.stateManager.getState(),a=e.columns.every(i=>e.visibleColumns.has(i.column)),s=new Set(e.visibleColumns);e.columns.forEach(i=>{a?s.delete(i.column):s.add(i.column)}),this.stateManager.update({visibleColumns:s}),this.renderControlList()}getToken(){var e;return((e=this.dom.token)==null?void 0:e.value)||""}getBerdlId(){var e;return((e=this.dom.berdl)==null?void 0:e.value)||""}setBerdlId(e){this.dom.berdl&&(this.dom.berdl.value=e)}renderCategories(){this.renderControlList()}renderColumnList(){this.renderControlList()}updateLoadingState(e){if(!this.dom.loadingIndicator||!this.dom.loadingText)return;e.loading&&e.availableTables.length===0?(this.dom.loadingIndicator.style.display="block",this.dom.sourceBody&&(this.dom.sourceBody.style.display="block",this.dom.sourceArrow.classList.remove("collapsed")),this.dom.loadingText.textContent="Fetching tables..."):this.dom.loadingIndicator.style.display="none"}}class xt extends st{constructor(e){super(e);m(this,"options");m(this,"searchTimer");this.options=e}render(){this.container.innerHTML=`
            <div class="ts-search-box">
                <div class="ts-search-input-wrap">
                    <input type="text" id="ts-search" class="ts-search" 
                        placeholder="Highlight matches (doesn't filter rows)..." 
                        aria-label="Highlight matches in table (does not filter rows)">
                    <button class="ts-search-clear" id="ts-search-clear" aria-label="Clear search">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <i class="bi bi-search ts-search-icon"></i>
                </div>
                <div class="ts-search-nav">
                    <button class="ts-search-nav-btn" id="ts-search-prev" title="Previous match (Shift+Enter)" aria-label="Previous match">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                    <span class="ts-search-nav-info" id="ts-search-info">0/0</span>
                    <button class="ts-search-nav-btn" id="ts-search-next" title="Next match (Enter)" aria-label="Next match">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div class="ts-spacer" style="flex:1"></div>
            <div class="ts-toolbar-actions">
                <button class="ts-tb-btn" id="ts-test-connection" title="Test API Connection" style="margin-right: 8px;">
                    <i class="bi bi-lightning-charge"></i> Test Connection
                </button>
                <button class="ts-tb-btn" id="ts-refresh" title="Refresh Data">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="ts-tb-icon" id="ts-settings-btn" title="Settings">
                    <i class="bi bi-gear-fill"></i>
                </button>
            </div>
        `,this.cacheDom({search:"#ts-search",searchClear:"#ts-search-clear",searchPrev:"#ts-search-prev",searchNext:"#ts-search-next",searchInfo:"#ts-search-info",testConn:"#ts-test-connection",refresh:"#ts-refresh",settings:"#ts-settings-btn"})}bindEvents(){var e,a,s,i,n,o,r;(e=this.dom.search)==null||e.addEventListener("input",()=>{clearTimeout(this.searchTimer);const l=this.dom.search.value;this.updateSearchNav(),this.searchTimer=setTimeout(()=>{this.options.onSearch(l),setTimeout(()=>this.updateSearchNav(),350)},300)}),(a=this.dom.search)==null||a.addEventListener("keydown",l=>{var d,c,f,h;l.key==="Enter"&&!l.shiftKey?(l.preventDefault(),(c=(d=this.options).onSearchNext)==null||c.call(d),this.updateSearchNav()):l.key==="Enter"&&l.shiftKey&&(l.preventDefault(),(h=(f=this.options).onSearchPrev)==null||h.call(f),this.updateSearchNav())}),(s=this.dom.searchClear)==null||s.addEventListener("click",()=>{this.dom.search.value="",this.options.onSearch(""),this.updateSearchNav(),this.dom.search.focus()}),(i=this.dom.searchPrev)==null||i.addEventListener("click",()=>{var l,d;(d=(l=this.options).onSearchPrev)==null||d.call(l),this.updateSearchNav()}),(n=this.dom.searchNext)==null||n.addEventListener("click",()=>{var l,d;(d=(l=this.options).onSearchNext)==null||d.call(l),this.updateSearchNav()}),(o=this.dom.refresh)==null||o.addEventListener("click",()=>this.options.onRefresh()),(r=this.dom.testConn)==null||r.addEventListener("click",()=>{this.options.onTestConnection&&this.options.onTestConnection()}),setTimeout(()=>this.updateSearchNav(),100)}updateSearchNav(){var i;const e=this.dom.search,a=((i=e==null?void 0:e.value)==null?void 0:i.trim())||"",s=this.container.querySelector(".ts-search-nav");if(s){if(a)s.style.opacity="1",s.style.pointerEvents="auto";else{s.style.opacity="0",s.style.pointerEvents="none";return}if(this.options.getSearchMatchInfo){const n=this.options.getSearchMatchInfo();this.dom.searchInfo&&(n.total>0?(this.dom.searchInfo.textContent=`${n.current}/${n.total}`,this.dom.searchPrev.disabled=!1,this.dom.searchNext.disabled=!1):(this.dom.searchInfo.textContent="0/0",this.dom.searchPrev.disabled=!0,this.dom.searchNext.disabled=!0))}}}getSettingsButton(){return this.dom.settings}setSearch(e){this.dom.search&&(this.dom.search.value=e)}focusSearch(){this.dom.search&&(this.dom.search.focus(),this.dom.search.select())}}const u=class u{static escapeHtml(t){if(t==null)return"";const e=document.createElement("div");return e.textContent=String(t),e.innerHTML}static apply(t,e,a){if(!e)return t!=null?u.escapeHtml(String(t)):"";if(Array.isArray(e))return u.chain(t,{transforms:e},a);const s=e;if(s.condition&&!u.evaluateCondition(s.condition,t,a))return s.fallback?typeof s.fallback=="string"?u.escapeHtml(s.fallback):u.apply(t,s.fallback,a):t!=null?u.escapeHtml(String(t)):"";const i=e.type;if(typeof u[i]=="function")return u[i](t,e.options||{},a);if(u.customTransformers.has(i)){const n=u.customTransformers.get(i);if(n)return n(t,e.options||{},a)}return $.warn(`Unknown transformer type: "${i}"`),t!=null?u.escapeHtml(String(t)):""}static evaluateCondition(t,e,a){const s=t.column?a[t.column]:e,i=t.value;switch(t.operator){case"eq":return s===i;case"neq":return s!==i;case"gt":return Number(s)>Number(i);case"gte":return Number(s)>=Number(i);case"lt":return Number(s)<Number(i);case"lte":return Number(s)<=Number(i);case"contains":return String(s).includes(String(i));case"startsWith":return String(s).startsWith(String(i));case"endsWith":return String(s).endsWith(String(i));case"regex":return new RegExp(String(i)).test(String(s));case"isEmpty":return s==null||s==="";case"isNotEmpty":return s!=null&&s!=="";default:return!0}}static chain(t,e,a){if(!e.transforms||!Array.isArray(e.transforms))return u.escapeHtml(String(t??""));let s=t;for(const i of e.transforms){if(e.transforms.indexOf(i)===e.transforms.length-1)return u.apply(s,i,a);s=u.apply(s,i,a)}return u.escapeHtml(String(s??""))}static number(t,e,a){if(t==null||t==="")return"";const s=Number(t);if(isNaN(s))return u.escapeHtml(String(t));const i=e.decimals??2,n=e.locale||"en-US",o=e.prefix||"",r=e.suffix||"";let l;return e.notation==="scientific"?l=s.toExponential(i):e.notation==="compact"?l=new Intl.NumberFormat(n,{notation:"compact",maximumFractionDigits:i}).format(s):e.notation==="engineering"?l=s.toExponential(i):l=new Intl.NumberFormat(n,{minimumFractionDigits:e.minDecimals??0,maximumFractionDigits:i}).format(s),`<span class="ts-number">${u.escapeHtml(o)}${l}${u.escapeHtml(r)}</span>`}static percentage(t,e,a){if(t==null||t==="")return"";let s=Number(t);if(isNaN(s))return u.escapeHtml(String(t));e.scale100!==!1&&s>=0&&s<=1&&(s*=100);const i=e.decimals??1,n=s.toFixed(i);if(e.showBar){const o=Math.min(100,Math.max(0,s)),r=e.color||"#6366f1";return`
                <div class="ts-percentage">
                    <div class="ts-percentage-bar" style="width:${o}%;background:${r}"></div>
                    <span class="ts-percentage-value">${n}%</span>
                </div>
            `}return`<span class="ts-number">${n}%</span>`}static currency(t,e,a){if(t==null||t==="")return"";const s=Number(t);if(isNaN(s))return u.escapeHtml(String(t));const i=e.locale||"en-US",n=e.currency||"USD";return`<span class="ts-currency">${new Intl.NumberFormat(i,{style:"currency",currency:n,minimumFractionDigits:e.decimals??2,maximumFractionDigits:e.decimals??2}).format(s)}</span>`}static filesize(t,e,a){if(t==null||t==="")return"";const s=Number(t);if(isNaN(s))return u.escapeHtml(String(t));const i=e.binary!==!1,n=i?["B","KiB","MiB","GiB","TiB","PiB"]:["B","KB","MB","GB","TB","PB"],o=i?1024:1e3;let r=s,l=0;for(;r>=o&&l<n.length-1;)r/=o,l++;const d=e.decimals??(l===0?0:2);return`<span class="ts-filesize">${r.toFixed(d)} ${n[l]}</span>`}static duration(t,e,a){if(t==null||t==="")return"";let s=Number(t);if(isNaN(s))return u.escapeHtml(String(t));const i=e.format||"short";if(i==="clock"){const r=Math.floor(s/3600),l=Math.floor(s%3600/60),d=Math.floor(s%60);return r>0?`<span class="ts-duration">${r}:${String(l).padStart(2,"0")}:${String(d).padStart(2,"0")}</span>`:`<span class="ts-duration">${l}:${String(d).padStart(2,"0")}</span>`}const n=[{name:i==="long"?"day":"d",seconds:86400},{name:i==="long"?"hour":"h",seconds:3600},{name:i==="long"?"minute":"m",seconds:60},{name:i==="long"?"second":"s",seconds:1}],o=[];for(const r of n)if(s>=r.seconds){const l=Math.floor(s/r.seconds);s%=r.seconds,i==="long"?o.push(`${l} ${r.name}${l!==1?"s":""}`):o.push(`${l}${r.name}`)}return`<span class="ts-duration">${o.join(i==="long"?", ":" ")||"0s"}</span>`}static date(t,e,a){if(t==null||t==="")return"";const s=new Date(t);if(isNaN(s.getTime()))return u.escapeHtml(String(t));const i=e.locale||"en-US";return e.relative?`<span class="ts-date" title="${s.toISOString()}">${u.relativeTime(s)}</span>`:`<span class="ts-date">${new Intl.DateTimeFormat(i,{dateStyle:e.dateStyle||"medium"}).format(s)}</span>`}static datetime(t,e,a){if(t==null||t==="")return"";const s=new Date(t);if(isNaN(s.getTime()))return u.escapeHtml(String(t));const i=e.locale||"en-US",n=e.timezone||void 0;return`<span class="ts-datetime">${new Intl.DateTimeFormat(i,{dateStyle:e.dateStyle||"medium",timeStyle:e.timeStyle||"short",timeZone:n}).format(s)}</span>`}static relativeTime(t){const a=new Date().getTime()-t.getTime(),s=Math.abs(a/1e3),i=a<0,n=[[31536e3,"year"],[2592e3,"month"],[86400,"day"],[3600,"hour"],[60,"minute"],[1,"second"]];for(const[o,r]of n)if(s>=o){const l=Math.floor(s/o),d=l!==1?"s":"";return i?`in ${l} ${r}${d}`:`${l} ${r}${d} ago`}return"just now"}static boolean(t,e,a){const s=t===!0||t==="true"||t===1||t==="1";if(e.trueIcon||e.falseIcon){const o=s?e.trueIcon||"bi-check-circle-fill":e.falseIcon||"bi-x-circle",r=s?e.trueColor||"#22c55e":e.falseColor||"#ef4444";return`<i class="${o}" style="color:${r};font-size:1.1em"></i>`}const i=s?e.trueText||"Yes":e.falseText||"No";return`<span class="ts-boolean" style="color:${s?e.trueColor||"#22c55e":e.falseColor||"#94a3b8"}">${u.escapeHtml(i)}</span>`}static heatmap(t,e,a){if(t==null||t==="")return"";const s=Number(t);if(isNaN(s))return u.escapeHtml(String(t));const i=e.min??-4,n=e.max??4,o=e.colorScale||"diverging",r=(s-i)/(n-i),l=Math.max(0,Math.min(1,r));let d,c;if(o==="diverging"){let p,b,g;if(l<.5){const v=l*2;p=Math.round(59+196*v),b=Math.round(130+125*v),g=Math.round(246+9*v),c=v<.5?"#fff":"#1e293b"}else{const v=(l-.5)*2;p=Math.round(255+-16*v),b=Math.round(255+-187*v),g=Math.round(255+-187*v),c=v>.5?"#fff":"#1e293b"}d=`rgb(${p}, ${b}, ${g})`}else if(o==="sequential"){const p=Math.round(236+-228*l),b=Math.round(254+-109*l),g=Math.round(255+-77*l);d=`rgb(${p}, ${b}, ${g})`,c=l>.5?"#fff":"#1e293b"}else d="transparent",c="inherit";const f=e.decimals??2,h=e.showValue!==!1?s.toFixed(f):"";return`<span class="ts-heatmap" style="background:${d};color:${c}">${h}</span>`}static progress(t,e,a){if(t==null||t==="")return"";const s=Number(t);if(isNaN(s))return u.escapeHtml(String(t));const i=e.max??100,n=Math.min(100,Math.max(0,s/i*100)),o=e.color||"#6366f1",r=e.showValue!==!1;return`
            <div class="ts-progress">
                <div class="ts-progress-bar" style="width:${n}%;background:${o}"></div>
                ${r?`<span class="ts-progress-value">${s}${e.suffix||""}</span>`:""}
            </div>
        `}static link(t,e,a={}){if(t==null||t==="")return"";const s=String(t),i=encodeURIComponent(s);let n=e.urlTemplate.replace(/\{value\}/g,i);a&&Object.keys(a).length>0&&Object.keys(a).forEach(c=>{const f=`{${c}}`;n.includes(f)&&(n=n.replace(new RegExp(f.replace(/[{}]/g,"\\$&"),"g"),encodeURIComponent(String(a[c]||""))))});let o=s;e.labelTemplate&&(o=e.labelTemplate.replace(/\{value\}/g,s),a&&Object.keys(a).length>0&&Object.keys(a).forEach(c=>{o=o.replace(new RegExp(`\\{${c}\\}`,"g"),String(a[c]||""))}));const r=e.target||"_blank",l=r==="_blank"?' rel="noopener noreferrer"':"",d=e.icon?`<i class="${e.icon}"></i> `:"";return`<a href="${n}" target="${r}"${l} class="ts-cell-link">${d}${u.escapeHtml(o)}</a>`}static replace(t,e){if(t==null||t==="")return"";const a=String(t),s=e.pattern||e.find,i=e.replaceWith||e.replace||"";if(!s)return a;if(e.isRegex)try{const n=e.flags||"g",o=new RegExp(s,n);return a.replace(o,i)}catch(n){return $.error("Invalid regex in replace transformer",n),a}return a.split(s).join(i)}static merge(t,e,a){if(!a||!e.columns||!Array.isArray(e.columns))return"";const s=e.skipEmpty!==!1;if(e.template){let o=e.template;return e.columns.forEach(r=>{const l=a[r],d=`{${r}}`;s&&(l==null||l==="")?(o=o.replace(new RegExp(`\\s*\\(${d}\\)`,"g"),""),o=o.replace(new RegExp(`${d}\\s*[|,;:]\\s*`,"g"),""),o=o.replace(new RegExp(`\\s*[|,;:]\\s*${d}`,"g"),""),o=o.replace(d,"")):o=o.replace(d,String(l||""))}),u.escapeHtml(o.trim())}const i=e.separator||" | ",n=e.columns.map(o=>a[o]).filter(o=>!s||o!=null&&o!=="").map(o=>String(o));return u.escapeHtml(n.join(i))}static badge(t,e,a){if(t==null||t==="")return"";const s=String(t);let o=(e.colorMap||{})[s]||e.color||e.defaultColor;if(!o){const d=["#6366f1","#ef4444","#10b981","#f59e0b","#3b82f6","#8b5cf6","#ec4899","#06b6d4","#84cc16","#f97316"];let c=0;for(let f=0;f<s.length;f++)c=s.charCodeAt(f)+((c<<5)-c);o=d[Math.abs(c)%d.length]}const r=e.variant||"default";let l;return r==="subtle"?l=`background:${o}15;color:${o};border:none`:r==="outline"?l=`background:transparent;color:${o};border:1px solid ${o}`:l=`background:${o}20;color:${o};border:1px solid ${o}40`,`<span class="ts-badge" style="${l}">${u.escapeHtml(s)}</span>`}static array(t,e,a){if(t==null)return"";let s;if(Array.isArray(t))s=t;else if(typeof t=="string"){const l=e.separator||",";s=t.split(l).map(d=>d.trim()).filter(Boolean)}else return u.escapeHtml(String(t));const i=e.limit||5,n=s.slice(0,i),o=s.length-i,r=n.map(l=>u.badge(l,{color:e.color||"#6366f1",variant:"subtle"},a)).join(" ");return o>0?`${r} <span class="ts-badge-more">+${o}</span>`:r}static sequence(t,e){if(!t)return"";let a=String(t);if(e.chunkSize&&e.chunkSize>0){const r=new RegExp(`.{1,${e.chunkSize}}`,"g"),l=a.match(r);l&&(a=l.join(" "))}const s=e.maxLength||30,i=a,n=e.showCopyButton!==!1;a.length>s&&(a=a.substring(0,s)+"...");const o=n?`<button class="ts-copy-btn" data-id="${u.escapeHtml(i)}" title="Copy sequence"><i class="bi bi-clipboard"></i></button>`:"";return`<span class="ts-sequence" title="${u.escapeHtml(i)}">${u.escapeHtml(a)}${o}</span>`}static truncate(t,e){if(!t)return"";const a=String(t),s=e.length||50,i=e.ellipsis??"...";if(a.length<=s)return u.escapeHtml(a);const n=a.substring(0,s)+i;return`<span title="${u.escapeHtml(a)}">${u.escapeHtml(n)}</span>`}static preLoadOntology(t,e="custom"){const a=Date.now();Object.entries(t).forEach(([s,i])=>{const n=`${e}:${s}`;u.ontologyCache.set(n,{name:i,timestamp:a})})}static ontology(t,e,a){if(t==null||t==="")return"";const s=e.delimiter;if(s&&typeof t=="string"&&t.includes(s)){const i=t.split(s).map(n=>n.trim()).filter(Boolean);return i.length===0?"":`<div class="ts-ontology-list" style="display:flex;flex-wrap:wrap;gap:4px">
                ${i.map(n=>u.renderSingleOntologyTerm(n,e)).join("")}
            </div>`}return u.renderSingleOntologyTerm(String(t).trim(),e)}static renderSingleOntologyTerm(t,e){const a=`${e.ontologyType||"custom"}:${t}`,s=u.ontologyCache.get(a);return s&&Date.now()-s.timestamp<u.cacheTimeout?u.formatOntologyTerm(t,s.name,e):(u.lookupOntologyTerm(t,e,a),u.formatOntologyTerm(t,null,e))}static lookup(t,e,a){if(t==null||t==="")return"";const s=String(t);if(e.map&&typeof e.map=="object"){const i=e.map[s];if(i!==void 0)return u.escapeHtml(String(i))}if(e.apiUrl){const i=`lookup:${e.apiUrl}:${s}`,n=u.lookupCache.get(i);return n&&Date.now()-n.timestamp<u.cacheTimeout?u.escapeHtml(n.value):(u.performAsyncLookup(s,e,i),u.escapeHtml(s)+' <span class="ts-loading-indicator">...</span>')}return e.fallback?u.escapeHtml(e.fallback):u.escapeHtml(s)}static formatOntologyTerm(t,e,a){const s=a.showId!==!1,i=u.escapeHtml(t),n=a.style||"default";let o="#";a.urlTemplate&&(o=a.urlTemplate.replace(/\{value\}/g,encodeURIComponent(t))),e&&a.urlTemplate&&a.urlTemplate.includes("{name}")&&(o=o.replace(/\{name\}/g,encodeURIComponent(e)));const r=a.urlTemplate?"a":"span",l=a.urlTemplate?` href="${o}" target="_blank" rel="noopener noreferrer"`:"";if(n==="badge")return e?`<${r}${l} class="ts-badge ts-ontology-badge" data-term="${i}" style="text-decoration:none">${u.escapeHtml(e)}</${r}>`:`<${r}${l} class="ts-badge ts-ontology-badge ts-loading-term" data-term="${i}" style="text-decoration:none">${i}</${r}>`;if(e){const d=u.escapeHtml(e);return s?`<${r}${l} class="ts-ontology" data-term="${i}">${d} <span class="ts-ontology-id">(${i})</span></${r}>`:`<${r}${l} class="ts-ontology" data-term="${i}">${d}</${r}>`}return`<${r}${l} class="ts-ontology ts-loading-term" data-term="${i}">${i}</${r}>`}static async lookupOntologyTerm(t,e,a){try{let s=null;if(e.map&&e.map[t])s=e.map[t];else switch(e.ontologyType){case"GO":s=await u.lookupGO(t);break;case"KEGG":s=t;break;case"EC":s=t;break;case"custom":e.lookupEndpoint&&(s=await u.lookupCustom(t,e.lookupEndpoint));break}s&&(u.ontologyCache.set(a,{name:s,timestamp:Date.now()}),u.updateOntologyElements(t,s,e))}catch(s){$.warn(`Ontology lookup failed for ${t}`,s)}}static updateOntologyElements(t,e,a){document.querySelectorAll(`.ts-ontology[data-term="${t}"], .ts-ontology-badge[data-term="${t}"]`).forEach(i=>{i.classList.remove("ts-loading-term");const n=a.showId!==!1;i.classList.contains("ts-ontology-badge")?i.textContent=e:n?i.innerHTML=`${u.escapeHtml(e)} <span class="ts-ontology-id">(${u.escapeHtml(t)})</span>`:i.textContent=e})}static async lookupGO(t){var s,i;const e=await fetch(`https://www.ebi.ac.uk/QuickGO/services/ontology/go/terms/${t}`,{headers:{Accept:"application/json"}});return e.ok&&((i=(s=(await e.json()).results)==null?void 0:s[0])==null?void 0:i.name)||null}static async lookupCustom(t,e){const a=e.replace("{value}",encodeURIComponent(t)),s=await fetch(a);if(!s.ok)return null;const i=await s.json();return i.name||i.label||i.term||null}static async performAsyncLookup(t,e,a){try{const s=e.apiUrl.replace("{value}",encodeURIComponent(t)),i=await fetch(s);if(i.ok){const n=await i.json(),o=e.valuePath?n[e.valuePath]:n.value||n.name||n;o&&u.lookupCache.set(a,{value:String(o),timestamp:Date.now()})}}catch(s){$.error("Async lookup failed",s)}}static conditional(t,e,a){if(!e.conditions||!Array.isArray(e.conditions))return u.escapeHtml(String(t??""));for(const s of e.conditions)if(u.evaluateCondition(s.when,t,a)){if(s.transform)return u.apply(t,s.transform,a);if(s.value!==void 0)return u.escapeHtml(String(s.value))}return e.default?typeof e.default=="object"&&e.default.type?u.apply(t,e.default,a):u.escapeHtml(String(e.default)):u.escapeHtml(String(t??""))}static ontologyLookup(t,e,a){if(t==null||t==="")return"";let s;if(typeof t=="string"){const r=t.trim();if(r.startsWith("["))try{const l=JSON.parse(r);s=Array.isArray(l)?l.filter(Boolean).map(String):[r]}catch{s=[r]}else s=r.split(/[,;]/).map(l=>l.trim()).filter(Boolean)}else Array.isArray(t)?s=t.filter(Boolean).map(String):s=[String(t)];if(s.length===0)return"";const i=s.slice(0,e.limit||5).map(r=>u.renderOntologyLookupTerm(r,e)),n=s.length-(e.limit||5),o=n>0?`<span class="ts-ontology-more" title="${s.slice(e.limit||5).join(", ")}">+${n}</span>`:"";return`<div class="ts-ontology-lookup-list">${i.join("")}${o}</div>`}static renderOntologyLookupTerm(t,e){const a=e.idPattern||"(rxn\\d+|cpd\\d+)",s=t.match(new RegExp(a,"i")),i=s?s[1]:t,n=`ontolookup:${e.ontologyType||"custom"}:${i}`,o=u.ontologyCache.get(n),r=u.escapeHtml(t),l=e.showId!==!1,d=e.maxLength||50,c=e.style||"inline";let f="#";return e.urlTemplate&&(f=e.urlTemplate.replace(/\{id\}/g,encodeURIComponent(i))),o&&Date.now()-o.timestamp<u.cacheTimeout?u.formatOntologyLookupTerm(i,r,o.name,f,l,d,c):(u.lookupOntologyDescription(i,e,n),u.formatOntologyLookupTerm(i,r,null,f,l,d,c))}static formatOntologyLookupTerm(t,e,a,s,i,n,o){const r=u.escapeHtml(t),l=s!=="#",d=l?`href="${s}" target="_blank" rel="noopener noreferrer"`:"",c=l?"a":"span";if(o==="badge"){if(a){const f=a.length>n?a.substring(0,n)+"":a,h=`${e}: ${a}`;return`<${c} ${d} class="ts-badge ts-ontology-lookup-badge" data-term="${r}" title="${u.escapeHtml(h)}" style="text-decoration:none">
                    ${i?`<span class="ts-ontology-id">${r}</span>: `:""}
                    <span class="ts-ontology-name">${u.escapeHtml(f)}</span>
                </${c}>`}return`<${c} ${d} class="ts-badge ts-ontology-lookup-badge ts-loading-term" data-term="${r}" title="${e}" style="text-decoration:none">${r}</${c}>`}if(a){const f=a.length>n?a.substring(0,n)+"":a,h=`${e}: ${a}`;return`<${c} ${d} class="ts-ontology-lookup" data-term="${r}" title="${u.escapeHtml(h)}">
                ${i?`<span class="ts-ontology-id">${r}</span>: `:""}
                <span class="ts-ontology-name">${u.escapeHtml(f)}</span>
            </${c}>`}return`<${c} ${d} class="ts-ontology-lookup ts-loading-term" data-term="${r}" title="${e}">
            <span class="ts-ontology-id">${r}</span>
            <span class="ts-loading-indicator"></span>
        </${c}>`}static async lookupOntologyDescription(t,e,a){try{let s=null;switch(e.ontologyType||"custom"){case"modelseed_reactions":s=await u.lookupModelSeedReaction(t);break;case"modelseed_compounds":s=await u.lookupModelSeedCompound(t);break;case"go":s=await u.lookupGOTerm(t);break;case"kegg":s=await u.lookupKEGGOrtholog(t);break;case"pfam":s=await u.lookupPfamDomain(t);break;case"cog":s=await u.lookupCOG(t);break;case"ec":s=await u.lookupECNumber(t);break;case"so":s=await u.lookupSequenceOntology(t);break;case"uniref":s=await u.lookupUniRef(t);break;case"custom":if(e.apiUrl){const n=e.apiUrl.replace(/\{id\}/g,encodeURIComponent(t)),o=await fetch(n);if(o.ok){const r=await o.json();s=r.name||r.definition||r.equation||null}}break}s&&(u.ontologyCache.set(a,{name:s,timestamp:Date.now()}),u.updateOntologyLookupElements(t,s,e))}catch(s){$.warn(`Ontology lookup failed for ${t}`,s)}}static async lookupModelSeedReaction(t){var e,a;try{const s=await fetch(`https://modelseed.org/solr/reactions/select?q=id:${t}&wt=json`);if(!s.ok)return null;const i=await s.json();if(((a=(e=i.response)==null?void 0:e.docs)==null?void 0:a.length)>0){const n=i.response.docs[0];return n.definition||n.name||n.equation||null}return null}catch{return null}}static async lookupModelSeedCompound(t){var e,a;try{const s=await fetch(`https://modelseed.org/solr/compounds/select?q=id:${t}&wt=json`);if(!s.ok)return null;const i=await s.json();if(((a=(e=i.response)==null?void 0:e.docs)==null?void 0:a.length)>0){const n=i.response.docs[0];return n.name||n.formula||null}return null}catch{return null}}static async lookupGOTerm(t){var e,a;try{const s=t.startsWith("GO:")?t:`GO:${t}`,i=await fetch(`https://www.ebi.ac.uk/QuickGO/services/ontology/go/terms/${encodeURIComponent(s)}`,{headers:{Accept:"application/json"}});if(!i.ok)return null;const n=await i.json();return(a=(e=n.results)==null?void 0:e[0])!=null&&a.name?n.results[0].name:null}catch{return null}}static async lookupKEGGOrtholog(t){try{const e=t.replace(/^KEGG:/i,"").replace(/^ko:/i,""),a=await fetch(`https://rest.kegg.jp/get/${e}`);if(!a.ok)return null;const s=await a.text(),i=s.match(/^DEFINITION\s+(.+?)(?:\n|$)/m);if(i)return i[1].trim();const n=s.match(/^NAME\s+(.+?)(?:\n|$)/m);return n?n[1].trim():null}catch{return null}}static async lookupPfamDomain(t){var e;try{const a=t.startsWith("PF")?t:`PF${t}`,s=await fetch(`https://www.ebi.ac.uk/interpro/api/entry/pfam/${a}`,{headers:{Accept:"application/json"}});return s.ok&&((e=(await s.json()).metadata)==null?void 0:e.name)||null}catch{return null}}static async lookupCOG(t){try{const e=t.replace(/^COG:/i,"").trim();return e.length===1&&/^[A-Z]$/i.test(e)?await u.lookupCOGCategory(e.toUpperCase()):/^COG\d+$/i.test(e)?await u.lookupCOGId(e.toUpperCase()):null}catch{return null}}static async lookupCOGCategory(t){var e,a;try{const s=await fetch(`https://www.ncbi.nlm.nih.gov/research/cog/api/cog/?cat=${encodeURIComponent(t)}&format=json`);if(s.ok){const i=await s.json();if((a=(e=i.results)==null?void 0:e[0])!=null&&a.fun_cat_description)return i.results[0].fun_cat_description}return null}catch{return null}}static async lookupCOGId(t){try{const e=await fetch(`https://www.ncbi.nlm.nih.gov/research/cog/api/cog/${encodeURIComponent(t)}/?format=json`);if(!e.ok)return null;const a=await e.json();return a.cog_name?a.cog_name:a.fun_cat_description?a.fun_cat_description:null}catch{return null}}static async lookupECNumber(t){try{const e=t.replace(/^EC:/i,"").trim(),a=await fetch(`https://rest.kegg.jp/get/ec:${e}`);if(!a.ok)return null;const i=(await a.text()).match(/^NAME\s+(.+?)(?:\n|$)/m);return i?i[1].split(";")[0].trim():null}catch{return null}}static async lookupSequenceOntology(t){var e,a,s,i,n,o,r,l;try{const c=(t.startsWith("SO:")?t:`SO:${t}`).replace(":","_"),f=await fetch(`https://www.ebi.ac.uk/ols4/api/ontologies/so/terms?iri=http://purl.obolibrary.org/obo/${c}`,{headers:{Accept:"application/json"}});if(!f.ok){const p=await fetch(`https://www.ebi.ac.uk/ols/api/ontologies/so/terms?iri=http://purl.obolibrary.org/obo/${c}`,{headers:{Accept:"application/json"}});if(!p.ok)return null;const b=await p.json();return(s=(a=(e=b._embedded)==null?void 0:e.terms)==null?void 0:a[0])!=null&&s.label?b._embedded.terms[0].label:null}const h=await f.json();return(o=(n=(i=h._embedded)==null?void 0:i.terms)==null?void 0:n[0])!=null&&o.label?h._embedded.terms[0].label:(l=(r=h.elements)==null?void 0:r[0])!=null&&l.label?h.elements[0].label:null}catch{return null}}static async lookupUniRef(t){var e,a,s,i,n;try{let o=t;const r=t.match(/UniRef\d+_(\w+)/i);r&&(o=r[1]);const l=await fetch(`https://rest.uniprot.org/uniprotkb/${o}.json`);if(!l.ok)return null;const c=(await l.json()).proteinDescription;return(a=(e=c==null?void 0:c.recommendedName)==null?void 0:e.fullName)!=null&&a.value?c.recommendedName.fullName.value:(n=(i=(s=c==null?void 0:c.submissionNames)==null?void 0:s[0])==null?void 0:i.fullName)!=null&&n.value?c.submissionNames[0].fullName.value:null}catch{return null}}static updateOntologyLookupElements(t,e,a){const s=a.maxLength||50,i=a.showId!==!1,n=e.length>s?e.substring(0,s)+"":e;document.querySelectorAll(`.ts-ontology-lookup[data-term="${t}"], .ts-ontology-lookup-badge[data-term="${t}"]`).forEach(r=>{r.classList.remove("ts-loading-term"),r.setAttribute("title",`${t}: ${e}`);const l=i?`<span class="ts-ontology-id">${u.escapeHtml(t)}</span>: `:"";r.innerHTML=`${l}<span class="ts-ontology-name">${u.escapeHtml(n)}</span>`})}static register(t,e){u.customTransformers.set(t,e),$.info(`Registered custom transformer: ${t}`)}static unregister(t){return u.customTransformers.delete(t)}static getAvailableTransformers(){const t=["number","percentage","currency","filesize","duration","date","datetime","boolean","heatmap","progress","link","replace","merge","badge","array","sequence","truncate","ontology","ontologyLookup","lookup","chain","conditional"],e=Array.from(u.customTransformers.keys());return[...t,...e]}static custom(t,e,a){const s=u.customTransformers.get(e.functionName);if(!s)return t?String(t):"";try{return s(t,e.params||{},a)}catch(i){return console.error("Custom transformer error",i),t?String(t):""}}};m(u,"ontologyCache",new Map),m(u,"lookupCache",new Map),m(u,"cacheTimeout",36e5),m(u,"customTransformers",new Map);let I=u;class St extends st{constructor(e){super(e);m(this,"stateManager");m(this,"options");m(this,"tooltip",null);m(this,"focusedFilterCol",null);m(this,"selectionStart",null);m(this,"selectionEnd",null);m(this,"filterDebounceTimer",null);m(this,"searchMatches",[]);m(this,"currentMatchIndex",-1);m(this,"selection",new Set);this.stateManager=e.stateManager,this.options=e,this.stateManager.subscribe(()=>{this.render()})}render(){const e=this.stateManager.getState();if(e.columns.length===0){this.container.innerHTML=`
                <div class="ts-empty">
                    <div class="ts-empty-icon"><i class="bi bi-inbox-fill"></i></div>
                    <h3 class="ts-empty-title">No Data Loaded</h3>
                    <p class="text-muted">Select a data source from the sidebar to begin.</p>
                </div>`;return}const a=e.columns.filter(o=>e.visibleColumns.has(o.column));if(a.length===0){this.container.innerHTML=`
                <div class="ts-empty">
                    <div class="ts-empty-icon"><i class="bi bi-layout-three-columns"></i></div>
                    <h3 class="ts-empty-title">All Columns Hidden</h3>
                    <p class="text-muted">Enable columns in the sidebar to view data.</p>
                </div>`;return}const s=e.searchValue?e.searchValue.trim().toLowerCase():"";let i='<table class="ts-table"><thead><tr>';const n=e.data.length>0&&e.data.every((o,r)=>this.selection.has(r));if(i+=`<th class="ts-col-select ts-col-fixed"><input type="checkbox" id="ts-select-all" ${n?"checked":""}></th>`,e.showRowNumbers&&(i+='<th class="ts-col-num ts-col-fixed">#</th>'),a.forEach((o,r)=>{const d=r===0&&!e.showRowNumbers?"ts-col-fixed":"",c=o.sortable?"sortable":"",f=e.sortColumn===o.column?e.sortOrder==="asc"?' <i class="bi bi-sort-up"></i>':' <i class="bi bi-sort-down"></i>':"",h=o.width&&o.width!=="auto"?`width:${o.width}`:"min-width:80px";i+=`<th class="${d} ${c}" data-col="${o.column}" style="${h}">${o.displayName||o.column}${f}</th>`}),i+='</tr><tr class="ts-filter-row">',i+='<th class="ts-col-select ts-col-fixed" style="width:48px"></th>',e.showRowNumbers&&(i+='<th class="ts-col-num ts-col-fixed" style="width:60px"></th>'),a.forEach((o,r)=>{const d=r===0&&!e.showRowNumbers?"ts-col-fixed":"",c=e.columnFilters[o.column]||"",f=o.width&&o.width!=="auto"?`width:${o.width}`:"min-width:80px",h=this.options.getColumnType?this.options.getColumnType(o.column):"TEXT",p=["INTEGER","REAL","NUMERIC"].includes(h.toUpperCase()),b=p?"e.g., <500, >=100, =50":"Filter...",g=p?"Supports: <, <=, >, >=, =, !=, between, or just number":"Text search, =value, !=value, in(list), between";i+=`<th class="${d}" style="${f}">`,o.filterable!==!1?i+=`<div class="ts-filter-wrap"><input class="ts-filter-input ${c?"has-value":""}" data-col="${o.column}" data-type="${h}" value="${I.escapeHtml(c)}" placeholder="${b}" title="${g}"><button class="ts-filter-clear" data-col="${o.column}"><i class="bi bi-x"></i></button></div>`:i+='<div style="height:28px"></div>',i+="</th>"}),i+="</tr></thead><tbody>",e.data.length===0){const o=a.length+(e.showRowNumbers?1:0);i+=`<tr><td colspan="${o}" style="text-align:center;padding:32px;color:var(--text-muted)"><i class="bi bi-search" style="font-size:20px;opacity:.3;display:block;margin-bottom:6px"></i>No matching records</td></tr>`}else{const o=e.currentPage*e.pageSize+1;e.data.forEach((r,l)=>{const d=this.isRowSelected(l),c=o+l;i+=`<tr class="${d?"selected":""}" data-idx="${l}">`,i+=`<td class="ts-col-select ts-col-fixed"><input type="checkbox" class="ts-row-checkbox" data-idx="${l}" ${d?"checked":""}></td>`,e.showRowNumbers&&(i+=`<td class="ts-col-num ts-col-fixed">${c}</td>`),a.forEach((f,h)=>{const b=h===0&&!e.showRowNumbers?"ts-col-fixed":"",g=r[f.column];let v="";const w=g!=null?String(g):"";if(f.transform)v=I.apply(g,f.transform,r);else if(f.column.includes("ID")||f.column==="ID"){const S=I.escapeHtml(w);v=`<span class="ts-copy-id"><span class="ts-mono">${S}</span><button class="ts-copy-btn" data-id="${S}"><i class="bi bi-clipboard"></i></button></span>`}else v=I.escapeHtml(w);s&&s.trim()&&(v=this.highlightText(v,s).content),i+=`<td class="${b}" data-row="${l}" data-col="${f.column}">${v}</td>`}),i+="</tr>"})}i+="</tbody></table>",this.container.innerHTML=i,e.searchValue&&e.searchValue.trim()?this.trackSearchMatches(e.searchValue.trim()):(this.searchMatches=[],this.currentMatchIndex=-1),this.bindEvents(),this.restoreFocus()}restoreFocus(){if(this.focusedFilterCol){const e=this.container.querySelector(`input.ts-filter-input[data-col="${this.focusedFilterCol}"]`);e&&(e.focus(),this.selectionStart!==null&&this.selectionEnd!==null&&e.setSelectionRange(this.selectionStart,this.selectionEnd))}}getSelection(){return this.selection}clearSelection(){this.selection.clear(),this.render()}selectAll(){this.stateManager.getState().data.forEach((a,s)=>this.selection.add(s)),this.render(),this.options.onRowSelect(-1,!0,!0)}clearFilterFocus(){this.focusedFilterCol=null,this.selectionStart=null,this.selectionEnd=null,this.filterDebounceTimer&&(clearTimeout(this.filterDebounceTimer),this.filterDebounceTimer=null)}isRowSelected(e){return this.selection.has(e)}bindEvents(){this.container.addEventListener("change",e=>{const a=e.target;if(a.id==="ts-select-all"){const s=this.stateManager.getState();a.checked?s.data.forEach((i,n)=>this.selection.add(n)):this.selection.clear(),this.render(),this.options.onRowSelect(-1,a.checked,!0);return}if(a.classList.contains("ts-row-checkbox")){const s=parseInt(a.dataset.idx||"-1");s>=0&&(a.checked?this.selection.add(s):this.selection.delete(s),this.render(),this.options.onRowSelect(s,a.checked));return}}),this.container.onclick=e=>{var o;const a=e.target,s=a.closest("th.sortable");if(s){const r=s.dataset.col;if(r){const l=this.stateManager.getState(),d=l.sortColumn===r&&l.sortOrder==="asc"?"desc":"asc";this.options.onSort(r,d)}return}const i=a.closest(".ts-filter-clear");if(i){const r=i.dataset.col;r&&this.options.onFilter(r,"");return}if(a.tagName!=="BUTTON"&&a.tagName!=="INPUT"&&!a.closest("a")&&!a.closest(".ts-copy-btn")){const r=a.closest("tr");if(r&&((o=r.parentElement)==null?void 0:o.tagName)==="TBODY"){const l=parseInt(r.dataset.idx||"-1");if(l>=0){const d=this.selection.has(l);d?this.selection.delete(l):this.selection.add(l),this.render(),this.options.onRowSelect(l,!d)}}}const n=a.closest(".ts-copy-btn");if(n){const r=n.dataset.id;r&&navigator.clipboard.writeText(r)}},this.container.oninput=e=>{const a=e.target;if(a.classList.contains("ts-filter-input")){const s=a.dataset.col;s&&(this.focusedFilterCol=s,this.selectionStart=a.selectionStart,this.selectionEnd=a.selectionEnd,this.filterDebounceTimer&&clearTimeout(this.filterDebounceTimer),this.filterDebounceTimer=setTimeout(()=>{this.options.onFilter(s,a.value)},300))}},this.container.onkeyup=e=>{const a=e.target;a.classList.contains("ts-filter-input")&&(this.selectionStart=a.selectionStart,this.selectionEnd=a.selectionEnd)},this.container.addEventListener("focusin",e=>{const a=e.target;a.classList.contains("ts-filter-input")?this.focusedFilterCol=a.dataset.col||null:this.focusedFilterCol=null}),this.container.onmouseover=e=>{var s;const a=e.target.closest("td");if(a&&a.scrollWidth>a.clientWidth){const i=(s=a.textContent)==null?void 0:s.trim();i&&this.showTooltip(e,i)}},this.container.onmouseout=e=>{e.target.closest("td")&&this.hideTooltip()}}showTooltip(e,a){this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.className="ts-tooltip",this.tooltip.id="ts-tooltip",document.body.appendChild(this.tooltip)),this.tooltip.textContent=a,this.tooltip.classList.add("show"),this.tooltip.style.left=e.clientX+10+"px",this.tooltip.style.top=e.clientY+10+"px"}hideTooltip(){this.tooltip&&this.tooltip.classList.remove("show")}highlightText(e,a){if(!a||!a.trim())return{content:e,hasMatches:!1};const s=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`(${s})`,"gi"),n=document.createElement("div");n.innerHTML=e;const o=(n.textContent||n.innerText||"").toLowerCase();if(!o.includes(a.toLowerCase()))return{content:e,hasMatches:!1};if(!e.includes("<")||e===I.escapeHtml(o))return i.lastIndex=0,{content:e.replace(i,'<mark class="highlight">$1</mark>'),hasMatches:!0};const l=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null),d=[];let c;for(;c=l.nextNode();)if(c.textContent&&(i.lastIndex=0,i.test(c.textContent))){i.lastIndex=0;const f=c.textContent.replace(i,'<mark class="highlight">$1</mark>');d.push({node:c,replacement:f})}return d.forEach(({node:f,replacement:h})=>{const p=f.parentElement;if(p){const b=document.createElement("span");for(b.innerHTML=h;b.firstChild;)p.insertBefore(b.firstChild,f);p.removeChild(f)}}),{content:n.innerHTML,hasMatches:d.length>0}}trackSearchMatches(e){if(this.searchMatches=[],!e||!e.trim()){this.currentMatchIndex=-1;return}this.container.querySelectorAll("mark.highlight").forEach(s=>{const i=s.closest("td[data-row][data-col]");i&&this.searchMatches.push({element:s,row:parseInt(i.getAttribute("data-row")||"0"),col:0})}),this.searchMatches.length>0?(this.currentMatchIndex=0,this.highlightCurrentMatch()):this.currentMatchIndex=-1}navigateToNextMatch(){return this.searchMatches.length===0?!1:(this.currentMatchIndex=(this.currentMatchIndex+1)%this.searchMatches.length,this.highlightCurrentMatch(),!0)}navigateToPreviousMatch(){return this.searchMatches.length===0?!1:(this.currentMatchIndex=this.currentMatchIndex<=0?this.searchMatches.length-1:this.currentMatchIndex-1,this.highlightCurrentMatch(),!0)}highlightCurrentMatch(){if(this.container.querySelectorAll("mark.highlight").forEach(e=>{e.classList.remove("active")}),this.currentMatchIndex>=0&&this.currentMatchIndex<this.searchMatches.length){const e=this.searchMatches[this.currentMatchIndex];e.element.classList.add("active"),this.scrollToMatch(e.element)}}scrollToMatch(e){const a=e.closest("td");if(!a)return;const s=this.container.closest(".ts-grid");if(!s)return;const i=a.getBoundingClientRect(),n=s.getBoundingClientRect(),o=50;if(!(i.top>=n.top+o&&i.bottom<=n.bottom-o&&i.left>=n.left+o&&i.right<=n.right-o)){const l=s,d=a.offsetTop,c=a.offsetLeft,f=l.clientHeight,h=l.clientWidth,p=d-f/2+a.clientHeight/2,b=c-h/2+a.clientWidth/2;l.scrollTo({top:Math.max(0,p),left:Math.max(0,b),behavior:"smooth"})}}getSearchMatchInfo(){return{current:this.currentMatchIndex>=0?this.currentMatchIndex+1:0,total:this.searchMatches.length}}hasSearchMatches(){return this.searchMatches.length>0}}class Tt{constructor(t){m(this,"configManager");m(this,"stateManager");m(this,"client");m(this,"createModal");m(this,"switchTable");m(this,"fetchData");m(this,"getSchemaForTable");m(this,"getConfigColumns");m(this,"getStateColumns");m(this,"searchTerm","");m(this,"searchResults",[]);m(this,"isSearchingData",!1);m(this,"modal",null);m(this,"schemaCache",{});m(this,"loadingTables",new Set);this.configManager=t.configManager,this.stateManager=t.stateManager,this.client=t.client,this.createModal=t.createModal,this.switchTable=t.switchTable.bind(t.switchTable),this.fetchData=t.fetchData.bind(t.fetchData),this.getSchemaForTable=t.getSchemaForTable,this.getConfigColumns=t.getConfigColumns,this.getStateColumns=t.getStateColumns}renderSchemaItem(t){const e=[];t.sortable&&e.push({l:"Sortable",bg:"#dbeafe",fg:"#1d4ed8"}),t.filterable&&e.push({l:"Filterable",bg:"#d1fae5",fg:"#059669"}),t.copyable&&e.push({l:"Copyable",bg:"#e2e8f0",fg:"#475569"}),t.pin&&e.push({l:"Pinned",bg:"#ede9fe",fg:"#7c3aed"}),t.pk&&e.push({l:"Primary",bg:"#fee2e2",fg:"#b91c1c"}),t.notnull&&e.push({l:"Not Null",bg:"#fef9c3",fg:"#92400e"});const a=e.map(i=>`<span style="font-size:10px;padding:3px 8px;border-radius:4px;background:${i.bg};color:${i.fg};margin-right:6px;font-weight:500">${i.l}</span>`).join(""),s=(t.type||t.dataType||"string").toString().toUpperCase();return`
            <div class="ts-schema-item">
                <div style="padding-top:4px;flex-shrink:0"><i class="bi bi-hash" style="color:var(--c-accent);font-size:16px"></i></div>
                <div style="flex:1;min-width:0">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:12px">
                        <span class="ts-schema-name">${t.displayName||t.column}</span>
                        <span class="ts-schema-type">${s}</span>
                    </div>
                    ${t.description?`<div class="ts-schema-desc">${t.description}</div>`:""}
                    <div style="display:flex;align-items:center;margin-top:8px;flex-wrap:wrap;gap:4px">
                        ${a}
                        <span style="font-size:11px;color:var(--c-text-muted);font-family:'JetBrains Mono',monospace;margin-left:auto">col: ${t.column}</span>
                    </div>
                </div>
            </div>
        `}async show(t){const e=this.stateManager.getState(),a=e.availableTables||[],s=t||null;this.searchTerm="",this.searchResults=[],this.isSearchingData=!1;const i=(g,v="")=>{const w=v.trim().length>0;return`
                <div class="glass-sidebar" style="width:260px;display:flex;flex-direction:column;height:100%">
                    <div style="padding:16px;border-bottom:1px solid var(--c-border-subtle)">
                        <h3 style="font-size:11px;text-transform:uppercase;color:var(--c-text-muted);font-weight:700;letter-spacing:0.08em;display:flex;align-items:center;gap:8px;margin-bottom:12px">
                            <i class="bi bi-database" style="font-size:14px"></i> Database Schema
                        </h3>
                        <div style="position:relative;margin-bottom:8px">
                            <input type="text" id="ts-db-search" placeholder="Search tables, columns, data..." 
                                value="${v}"
                                style="background:var(--c-bg-input);border:1px solid var(--c-border-subtle);border-radius:var(--radius-sm);font-size:12px;padding:6px 12px 6px 32px;width:100%;outline:none;color:var(--c-text-primary);box-sizing:border-box">
                            <i class="bi bi-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--c-text-muted);pointer-events:none"></i>
                            ${w?'<button id="ts-db-search-clear" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--c-text-muted);cursor:pointer;padding:2px;font-size:14px"><i class="bi bi-x"></i></button>':""}
                        </div>
                        ${w?`
                            <div style="display:flex;gap:4px;margin-top:4px">
                                <button id="ts-search-data-btn" class="ts-btn-secondary" style="flex:1;height:28px;font-size:11px;padding:0 8px;${this.isSearchingData?"opacity:0.6":""}" ${this.isSearchingData?"disabled":""}>
                                    <i class="bi bi-${this.isSearchingData?"hourglass-split":"search"}"></i> ${this.isSearchingData?"Searching...":"Search Data"}
                                </button>
                            </div>
                        `:""}
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:12px">
                        ${w?`
                            <div style="margin-bottom:8px;padding:0 14px">
                                <span style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-text-muted);font-weight:600">
                                    ${this.searchResults.length>0?`Results (${this.searchResults.length})`:"No Results"}
                                </span>
                            </div>
                            ${this.searchResults.length>0?this.searchResults.map(S=>{const k=S.columns.length+(S.hasDataMatches?1:0);return`
                                    <div class="ts-nav-item ${g===S.table.name?"active":""}" 
                                         data-target="${S.table.name}" 
                                         data-search="${v}"
                                         style="cursor:pointer">
                                        <i class="bi bi-table"></i> 
                                        <div style="flex:1;min-width:0">
                                            <div style="font-weight:${g===S.table.name?"600":"500"}">${S.table.name}</div>
                                            <div style="font-size:10px;color:var(--c-text-muted);margin-top:2px">
                                                ${k} match${k!==1?"es":""}
                                                ${S.hasDataMatches?"  Has data matches":""}
                                            </div>
                                        </div>
                                    </div>
                                `}).join(""):`
                                <div style="padding:24px;text-align:center;color:var(--c-text-muted)">
                                    <i class="bi bi-search" style="font-size:24px;display:block;margin-bottom:8px;opacity:0.5"></i>
                                    <div style="font-size:12px">No matches found</div>
                                </div>
                            `}
                        `:`
                            <div class="ts-nav-item ${g?"":"active"}" data-target="__overview__">
                                <i class="bi bi-grid-1x2"></i> Overview
                            </div>
                            <div style="margin-top:12px;margin-bottom:8px;padding:0 14px">
                                <span style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-text-muted);font-weight:600">Tables (${a.length})</span>
                            </div>
                            ${a.map(S=>`
                                <div class="ts-nav-item ${g===S.name?"active":""}" data-target="${S.name}">
                                    <i class="bi bi-table"></i> 
                                    <span style="flex:1">${S.name}</span>
                                    <span style="font-size:11px;color:var(--c-text-muted)">${(S.row_count||0).toLocaleString()}</span>
                                </div>
                            `).join("")}
                        `}
                    </div>
                </div>
            `},n=()=>{const g=a.length,v=a.reduce((w,S)=>w+(S.row_count||0),0);return this.searchTerm&&this.searchResults.length>0?`
                    <div style="padding:40px;max-width:960px;margin:0 auto">
                        <div style="margin-bottom:32px">
                            <h2 style="font-size:24px;font-weight:700;color:var(--c-text-primary);margin-bottom:8px">
                                Search Results for "${this.searchTerm}"
                            </h2>
                            <p style="color:var(--c-text-secondary);font-size:14px">Found ${this.searchResults.length} table${this.searchResults.length!==1?"s":""} with matches</p>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:16px">
                            ${this.searchResults.map(w=>{const S=w.columns.length+(w.hasDataMatches?1:0);return`
                                    <div class="ts-card-nav" data-target="${w.table.name}" data-search="${this.searchTerm}" style="cursor:pointer">
                                        <div style="width:44px;height:44px;background:var(--c-accent-light);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--c-accent);font-size:20px">
                                            <i class="bi bi-table"></i>
                                        </div>
                                        <div style="flex:1">
                                            <div style="font-weight:600;font-size:14px;color:var(--c-text-primary)">${w.table.name}</div>
                                            <div style="font-size:12px;color:var(--c-text-muted);margin-top:4px">
                                                ${S} match${S!==1?"es":""}
                                                ${w.hasDataMatches?"  Data matches":""}
                                                ${w.columns.length>0?`  ${w.columns.length} column${w.columns.length!==1?"s":""}`:""}
                                            </div>
                                            ${w.columns.length>0?`
                                                <div style="margin-top:8px;font-size:11px;color:var(--c-text-muted);max-height:60px;overflow-y:auto">
                                                    ${w.columns.slice(0,3).map(k=>`
                                                        <div style="padding:2px 0"> ${k.displayName||k.column}</div>
                                                    `).join("")}
                                                    ${w.columns.length>3?`<div style="padding:2px 0;font-style:italic">+ ${w.columns.length-3} more</div>`:""}
                                                </div>
                                            `:""}
                                        </div>
                                        <i class="bi bi-chevron-right" style="font-size:14px;color:var(--c-text-muted)"></i>
                                    </div>
                                `}).join("")}
                        </div>
                    </div>
                `:`
                <div style="padding:48px;max-width:900px;margin:0 auto">
                    <div style="text-align:center;margin-bottom:48px">
                        <div style="width:80px;height:80px;background:linear-gradient(135deg, var(--c-accent-light) 0%, var(--c-accent-glow) 100%);color:var(--c-accent);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:40px;margin:0 auto 20px;box-shadow:0 8px 24px var(--c-accent-glow)">
                            <i class="bi bi-database"></i>
                        </div>
                        <h2 style="font-size:28px;font-weight:700;color:var(--c-text-primary);margin-bottom:8px">Database Overview</h2>
                        <p style="color:var(--c-text-secondary);font-size:14px">${e.berdlTableId||"Connected Database"}</p>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:20px;margin-bottom:48px">
                        <div class="glass-panel" style="padding:28px;text-align:center">
                            <div style="font-size:13px;color:var(--c-text-muted);margin-bottom:8px;font-weight:500">Total Tables</div>
                            <div style="font-size:40px;font-weight:700;color:var(--c-text-primary)">${g}</div>
                        </div>
                        <div class="glass-panel" style="padding:28px;text-align:center">
                            <div style="font-size:13px;color:var(--c-text-muted);margin-bottom:8px;font-weight:500">Total Records</div>
                            <div style="font-size:40px;font-weight:700;color:var(--c-text-primary)">${v.toLocaleString()}</div>
                        </div>
                    </div>
                    <h3 style="font-size:12px;font-weight:700;margin-bottom:20px;color:var(--c-text-muted);text-transform:uppercase;letter-spacing:0.08em">Available Tables</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px">
                        ${a.map(w=>`
                            <div class="ts-card-nav" data-target="${w.name}">
                                <div style="width:44px;height:44px;background:var(--c-accent-light);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--c-accent);font-size:20px"><i class="bi bi-table"></i></div>
                                <div style="flex:1">
                                    <div style="font-weight:600;font-size:14px;color:var(--c-text-primary)">${w.name}</div>
                                    <div style="font-size:12px;color:var(--c-text-muted);margin-top:2px">${(w.row_count||0).toLocaleString()} records</div>
                                </div>
                                <i class="bi bi-chevron-right" style="font-size:14px;color:var(--c-text-muted)"></i>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `},o=g=>{if(!g)return"STRING";const v=g.toUpperCase();return v.includes("INT")?"INTEGER":v.includes("REAL")||v.includes("DOUBLE")||v.includes("FLOAT")?"FLOAT":v.includes("CHAR")||v.includes("TEXT")||v.includes("CLOB")?"STRING":v.includes("BLOB")?"BLOB":v.includes("DATE")||v.includes("TIME")?"DATETIME":v},r=g=>{const v=this.configManager.getTableConfig(g),k=this.stateManager.getState().activeTableName===g?this.getStateColumns():[],x=this.schemaCache[g],C=x&&x.length>0?x:k.length>0?k:v.columns||[];if(x&&x.length>0)return x;const T=new Map((v.columns||[]).map(M=>[M.column,M]));return C.map(M=>{const E=M.column||M.name,L=T.get(E)||{},A=o(M.type||L.dataType||L.type);return{...L,...M,column:E,type:A,dataType:A}})},l=g=>{var T,M,E;const v=this.configManager.getTableConfig(g),w=e.activeTableName===g,S=r(g),k=this.loadingTables.has(g),x=(v==null?void 0:v.name)||g,C=((T=v==null?void 0:v.settings)==null?void 0:T.description)||"No description available for this table.";return`
                <div style="padding:40px;max-width:960px;margin:0 auto">
                    <div style="margin-bottom:36px">
                        <div style="display:flex;align-items:flex-start;gap:20px">
                            <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg, var(--c-accent-light) 0%, var(--c-accent-glow) 100%);color:var(--c-accent);display:flex;align-items:center;justify-content:center;font-size:32px;flex-shrink:0;box-shadow:0 4px 16px var(--c-accent-glow)">
                                <i class="${((M=v==null?void 0:v.settings)==null?void 0:M.icon)||"bi bi-table"}"></i>
                            </div>
                            <div style="flex:1">
                                <h2 style="font-size:24px;font-weight:700;color:var(--c-text-primary);margin:0 0 8px 0">${x}</h2>
                                <div style="font-size:14px;color:var(--c-text-secondary);line-height:1.6;margin-bottom:16px;max-width:600px">
                                    ${C}
                                </div>
                                <div style="display:flex;gap:20px;font-size:13px;color:var(--c-text-muted)">
                                    <span style="display:flex;align-items:center;gap:6px"><i class="bi bi-layout-three-columns"></i> ${S.length} Columns</span>
                                    ${w?`<span style="display:flex;align-items:center;gap:6px"><i class="bi bi-list-ol"></i> ${(E=e.totalCount)==null?void 0:E.toLocaleString()} Records</span>`:""}
                                    <span style="display:flex;align-items:center;gap:6px"><i class="bi bi-${w?'check-circle-fill" style="color:var(--success)':"circle"}"></i> ${w?"Currently Loaded":"Not Loaded"}</span>
                                </div>
                            </div>
                            <button id="ts-export-current" class="ts-btn-secondary" data-table="${g}" style="height:40px;padding:0 20px">
                                <i class="bi bi-download"></i> Export Schema
                            </button>
                        </div>
                    </div>
                    <div class="glass-panel" style="overflow:hidden">
                        <div style="padding:14px 20px;border-bottom:1px solid var(--c-border-subtle);display:flex;justify-content:space-between;align-items:center;background:rgba(248,250,252,0.3)">
                            <h4 style="margin:0;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-text-muted);display:flex;align-items:center;gap:8px">
                                <i class="bi bi-list-columns-reverse"></i> Schema Definition
                            </h4>
                            <div style="display:flex;align-items:center;gap:8px">
                                <button id="ts-refresh-schema" data-table="${g}" class="ts-btn-secondary" style="height:28px;padding:0 10px;font-size:11px">
                                    <i class="bi bi-arrow-repeat"></i> Refresh schema
                                </button>
                                <div style="position:relative">
                                <input type="text" id="ts-schema-filter" placeholder="Search columns..." style="background:var(--c-bg-input);border:1px solid var(--c-border-subtle);border-radius:var(--radius-sm);font-size:12px;padding:6px 12px 6px 32px;width:220px;outline:none;color:var(--c-text-primary)">
                                <i class="bi bi-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--c-text-muted)"></i>
                            </div>
                            </div>
                        </div>
                        <div id="ts-schema-items-container" style="max-height:55vh;overflow-y:auto">
                            ${k?'<div style="padding:48px;text-align:center;color:var(--c-text-muted)"><i class="bi bi-hourglass-split" style="font-size:24px;display:block;margin-bottom:12px;opacity:0.5"></i>Loading schema...</div>':S.length===0?'<div style="padding:48px;text-align:center;color:var(--c-text-muted)"><i class="bi bi-info-circle" style="font-size:24px;display:block;margin-bottom:12px;opacity:0.5"></i>No schema information yet. Click "Refresh schema" to fetch live schema.</div>':S.map(L=>this.renderSchemaItem(L)).join("")}
                        </div>
                    </div>
                </div>
             `},d=async g=>{if(!(!g||this.schemaCache[g]||this.loadingTables.has(g))){this.loadingTables.add(g),c(g);try{const v=await this.getSchemaForTable(g),w=this.getConfigColumns(g),S=new Map(w.map(x=>[x.column,x])),k=v.map(x=>{const C=x.column||x.name,T=S.get(C)||{},M=o(x.type||T.dataType||T.type);return{...T,column:C,displayName:T.displayName||C,type:M,dataType:M,description:T.description,sortable:T.sortable!==!1,filterable:T.filterable!==!1,copyable:T.copyable,pin:T.pin,pk:x.pk,notnull:x.notnull}});this.schemaCache[g]=k.length>0?k:w.map(x=>({...x,column:x.column,type:o(x.dataType||x.type),dataType:o(x.dataType||x.type)}))}catch(v){$.warn(`[SchemaViewer] Failed to load schema for table ${g}`,v)}finally{this.loadingTables.delete(g),c(g)}}},c=(g,v=this.searchTerm)=>{var k,x;const w=(k=this.modal)==null?void 0:k.querySelector("#ts-schema-sidebar"),S=(x=this.modal)==null?void 0:x.querySelector("#ts-schema-main");w&&(w.innerHTML=i(g==="__overview__"?null:g,v)),S&&(S.innerHTML=g==="__overview__"?n():l(g),S.scrollTop=0),h()},f=async(g,v=!1)=>{var k;if(this.searchTerm=g.trim(),this.searchResults=[],!this.searchTerm){c("__overview__");return}const w=this.searchTerm.toLowerCase(),S=this.stateManager.getState();for(const x of a){const C=x.name.toLowerCase().includes(w),T=this.configManager.getTableConfig(x.name),L=(S.activeTableName===x.name?S.columns:T.columns||[]).filter(A=>{const K=(A.displayName||A.column||"").toLowerCase(),U=(A.column||"").toLowerCase(),F=(A.description||"").toLowerCase();return K.includes(w)||U.includes(w)||F.includes(w)});(C||L.length>0)&&this.searchResults.push({table:x,columns:L,hasDataMatches:!1})}if(v&&S.berdlTableId){this.isSearchingData=!0;const x=(k=this.modal)==null?void 0:k.querySelector("#ts-schema-sidebar");x&&(x.innerHTML=i(null,this.searchTerm)),h();const C=a.map(async T=>{try{if((await this.client.getTableData({berdl_table_id:S.berdlTableId||"",table_name:T.name,limit:1,offset:0,search_value:this.searchTerm})).total_count>0){const E=this.searchResults.find(L=>L.table.name===T.name);E?E.hasDataMatches=!0:this.searchResults.push({table:T,columns:[],hasDataMatches:!0})}}catch(M){$.warn(`Failed to search data in table ${T.name}`,M)}});await Promise.all(C),this.isSearchingData=!1}c("__overview__")},h=()=>{if(!this.modal)return;const g=this.modal.querySelector("#ts-db-search"),v=this.modal.querySelector("#ts-db-search-clear"),w=this.modal.querySelector("#ts-search-data-btn");if(g){let x=null;g.addEventListener("input",()=>{const C=g.value;this.searchTerm=C,x&&clearTimeout(x),x=setTimeout(()=>{f(C,!1)},300)}),g.addEventListener("keypress",C=>{C.key==="Enter"&&(C.preventDefault(),x&&clearTimeout(x),f(g.value,!1))})}v&&v.addEventListener("click",()=>{g&&(g.value=""),this.searchTerm="",this.searchResults=[],this.isSearchingData=!1,c("__overview__","")}),w&&w.addEventListener("click",async()=>{!this.searchTerm||this.isSearchingData||await f(this.searchTerm,!0)}),this.modal.querySelectorAll(".ts-nav-item, .ts-card-nav").forEach(x=>{x.addEventListener("click",()=>{var M;const C=x.dataset.target,T=x.dataset.search;if(C)if(C!=="__overview__"&&T){const E=(M=this.modal)==null?void 0:M.querySelector(".ts-modal-close");E&&E.click(),this.switchTable(C).then(()=>{this.stateManager.update({searchValue:T,currentPage:0}),this.fetchData()})}else c(C,T||this.searchTerm),d(C)})});const S=this.modal.querySelector("#ts-schema-filter"),k=this.modal.querySelector("#ts-schema-items-container");if(S&&k&&S.addEventListener("input",()=>{const x=S.value.toLowerCase();k.querySelectorAll(".ts-schema-item").forEach(C=>{const T=(C.textContent||"").toLowerCase();C.style.display=T.includes(x)?"flex":"none"})}),this.modal){const x=this.modal.querySelector("#ts-export-current");x==null||x.addEventListener("click",()=>{var at;const T=x.dataset.table;if(!T)return;const M=this.stateManager.getState(),E=this.configManager.getTableConfig(T),L=(at=this.schemaCache[T])!=null&&at.length?this.schemaCache[T]:M.activeTableName===T?M.columns:E.columns||[],A=JSON.stringify(E||{tableName:T,columns:L},null,2),K=new Blob([A],{type:"application/json"}),U=URL.createObjectURL(K),F=document.createElement("a");F.href=U,F.download=`${T}_schema.json`,document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(U)});const C=this.modal.querySelector("#ts-refresh-schema");C==null||C.addEventListener("click",()=>{const T=C.dataset.table;T&&(delete this.schemaCache[T],d(T))})}},p=`
            <div style="display:flex;height:100%;overflow:hidden">
                <div id="ts-schema-sidebar">${i(s||null)}</div>
                <div id="ts-schema-main" style="flex:1;overflow-y:auto;background:var(--c-bg-app-solid);position:relative">
                    ${s?l(s):n()}
                </div>
            </div>
        `;this.modal=this.createModal("Database Explorer",p);const b=this.modal.querySelector(".ts-modal-body");b&&(b.style.padding="0",b.style.height="calc(80vh - 60px)"),h(),t&&d(t)}}class Ct{constructor(t){m(this,"stateManager");m(this,"client");m(this,"createModal");m(this,"showAlert");this.stateManager=t.stateManager,this.client=t.client||new V,this.createModal=t.createModal,this.showAlert=t.showAlert}async show(t){const e=this.stateManager.getState();if(!e.berdlTableId||!t){this.showAlert("No table selected","warning");return}const a=(s,i=2)=>s==null?"N/A":typeof s=="number"?Number.isInteger(s)?s.toLocaleString():s.toFixed(i):String(s);try{this.stateManager.update({loading:!0});const s=await this.client.getTableStatistics(e.berdlTableId,t);if(!s||!Array.isArray(s.columns))throw new Error("Invalid statistics response format");const i=`
                <div style="padding:24px;max-width:900px;overflow-y:auto;max-height:80vh">
                    <h2 style="margin-bottom:20px;font-size:18px;font-weight:600">
                        <i class="bi bi-graph-up"></i> Column Statistics: ${t}
                    </h2>
                    <div style="margin-bottom:16px;padding:12px;background:var(--c-bg-surface-alt);border-radius:var(--radius-sm);font-size:13px">
                        <strong>Total Rows:</strong> ${(s.row_count||0).toLocaleString()}
                    </div>
                    <div style="display:grid;gap:12px">
                        ${s.columns.map(n=>`
                            <div style="padding:16px;background:var(--c-bg-surface);border:1px solid var(--c-border-subtle);border-radius:var(--radius-md)">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <h3 style="font-size:14px;font-weight:600">${n.column||"Unknown"}</h3>
                                    <span style="font-size:11px;color:var(--c-text-muted);text-transform:uppercase">${n.type||"TEXT"}</span>
                                </div>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;font-size:12px">
                                    <div><strong>Nulls:</strong> ${(n.null_count??0).toLocaleString()}</div>
                                    <div><strong>Distinct:</strong> ${(n.distinct_count??0).toLocaleString()}</div>
                                    ${n.min!=null?`<div><strong>Min:</strong> ${a(n.min)}</div>`:""}
                                    ${n.max!=null?`<div><strong>Max:</strong> ${a(n.max)}</div>`:""}
                                    ${n.mean!=null?`<div><strong>Mean:</strong> ${a(n.mean,2)}</div>`:""}
                                    ${n.median!=null?`<div><strong>Median:</strong> ${a(n.median)}</div>`:""}
                                    ${n.stddev!=null?`<div><strong>StdDev:</strong> ${a(n.stddev,4)}</div>`:""}
                                </div>
                                ${n.sample_values&&n.sample_values.length>0?`
                                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--c-border-subtle)">
                                        <div style="font-size:11px;color:var(--c-text-muted);margin-bottom:6px">Sample Values:</div>
                                        <div style="display:flex;flex-wrap:wrap;gap:4px">
                                            ${n.sample_values.slice(0,10).map(o=>`
                                                <span style="padding:2px 8px;background:var(--c-bg-surface-alt);border-radius:4px;font-size:11px;font-family:monospace">${String(o??"").substring(0,30)}</span>
                                            `).join("")}
                                        </div>
                                    </div>
                                `:""}
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;this.createModal(`Column Statistics: ${t}`,i)}catch(s){$.error(`Failed to load statistics: ${s.message}`,s),this.showAlert(`Failed to load statistics: ${s.message}`,"danger")}finally{this.stateManager.update({loading:!1})}}}const j=class j{constructor(){m(this,"listeners",new Map);m(this,"wildcardListeners",new Set);m(this,"eventHistory",[]);m(this,"maxHistorySize",100);m(this,"debug",!1);typeof localStorage<"u"&&(this.debug=localStorage.getItem("DATATABLE_DEBUG")==="true")}static getInstance(){return j.instance||(j.instance=new j),j.instance}on(t,e){var s;this.listeners.has(t)||this.listeners.set(t,new Set);const a={callback:e,once:!1};return(s=this.listeners.get(t))==null||s.add(a),()=>{var i;(i=this.listeners.get(t))==null||i.delete(a)}}once(t,e){var s;this.listeners.has(t)||this.listeners.set(t,new Set);const a={callback:e,once:!0};return(s=this.listeners.get(t))==null||s.add(a),()=>{var i;(i=this.listeners.get(t))==null||i.delete(a)}}off(t,e){if(!e){this.listeners.delete(t);return}const a=this.listeners.get(t);if(a){for(const s of a)if(s.callback===e){a.delete(s);break}}}onAny(t){return this.wildcardListeners.add(t),()=>{this.wildcardListeners.delete(t)}}emit(t,e){this.debug&&$.debug(`[EventBus] ${t}`,e),this.eventHistory.push({event:t,data:e,timestamp:Date.now()}),this.eventHistory.length>this.maxHistorySize&&this.eventHistory.shift();const a=this.listeners.get(t);if(a){const s=[];for(const i of a)try{i.callback(e),i.once&&s.push(i)}catch(n){$.error(`[EventBus] Error in listener for ${t}`,n)}for(const i of s)a.delete(i)}for(const s of this.wildcardListeners)try{s(t,e)}catch(i){$.error("[EventBus] Error in wildcard listener",i)}if(this.listeners.has("*")){const s=this.listeners.get("*");if(s){const i={event:t,data:e};for(const n of s)n.callback(i)}}}getHistory(){return[...this.eventHistory]}clearHistory(){this.eventHistory=[]}setDebug(t){this.debug=t,typeof localStorage<"u"&&localStorage.setItem("DATATABLE_DEBUG",t?"true":"false")}listenerCount(t){var e;return((e=this.listeners.get(t))==null?void 0:e.size)??0}clear(t){t?this.listeners.delete(t):(this.listeners.clear(),this.wildcardListeners.clear())}};m(j,"instance");let tt=j;const O=tt.getInstance(),R=class R{constructor(){m(this,"defaults",{format:"csv",filename:"export",includeHeaders:!0,delimiter:",",lineEnding:"unix",jsonPretty:!1,chunkSize:1e3})}static getInstance(){return R.instance||(R.instance=new R),R.instance}async export(t,e){const a=Date.now(),s={...this.defaults,...e};O.emit("export:started",{format:s.format,rowCount:t.length});try{const i=s.columns||this.inferColumns(t);let n,o,r;switch(s.format){case"csv":n=this.toCSV(t,i,s),o="text/csv;charset=utf-8",r="csv";break;case"tsv":n=this.toCSV(t,i,{...s,delimiter:"	"}),o="text/tab-separated-values;charset=utf-8",r="tsv";break;case"json":n=this.toJSON(t,i,s),o="application/json;charset=utf-8",r="json";break;case"json-lines":n=this.toJSONLines(t,i,s),o="application/x-ndjson;charset=utf-8",r="jsonl";break;case"xlsx":console.warn("XLSX export not yet implemented, falling back to CSV"),n=this.toCSV(t,i,s),o="text/csv;charset=utf-8",r="csv";break;default:throw new Error(`Unsupported export format: ${s.format}`)}const l=`${s.filename}.${r}`;this.downloadFile(n,l,o);const d={success:!0,filename:l,format:s.format,rowCount:t.length,byteSize:new Blob([n]).size,duration:Date.now()-a};return O.emit("export:completed",d),d}catch(i){const n={success:!1,filename:s.filename,format:s.format,rowCount:0,byteSize:0,duration:Date.now()-a,error:i.message||String(i)};return O.emit("export:failed",{...n,error:n.error}),n}}async toClipboard(t,e){const a={format:"tsv",includeHeaders:!0,...e};try{const s=a.columns||this.inferColumns(t),i=this.toCSV(t,s,{...this.defaults,...a,delimiter:"	"});return await navigator.clipboard.writeText(i),O.emit("export:clipboard",{rowCount:t.length}),!0}catch(s){return console.error("Failed to copy to clipboard:",s),!1}}getExtension(t){return{csv:"csv",tsv:"tsv",json:"json","json-lines":"jsonl",xlsx:"xlsx"}[t]||"txt"}getMimeType(t){return{csv:"text/csv",tsv:"text/tab-separated-values",json:"application/json","json-lines":"application/x-ndjson",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}[t]||"text/plain"}toCSV(t,e,a){const s=[],i=a.lineEnding==="windows"?`\r
`:`
`,n=a.delimiter;a.includeHeaders&&s.push(e.map(o=>this.escapeCSV(o.header,n)).join(n));for(let o=0;o<t.length;o++){const r=t[o],l=e.map(d=>{let c=r[d.key];return d.transform&&(c=d.transform(c,r)),this.escapeCSV(this.formatValue(c),n)});if(s.push(l.join(n)),a.chunkSize&&o>0&&o%a.chunkSize===0){const d=o/t.length*100;O.emit("export:progress",{progress:d,processed:o,total:t.length})}}return s.join(i)}toJSON(t,e,a){const s=t.map(i=>{const n={};return e.forEach(o=>{let r=i[o.key];o.transform&&(r=o.transform(r,i)),n[o.key]=r}),n});return a.jsonPretty?JSON.stringify(s,null,2):JSON.stringify(s)}toJSONLines(t,e,a){const s=a.lineEnding==="windows"?`\r
`:`
`;return t.map(i=>{const n={};return e.forEach(o=>{let r=i[o.key];o.transform&&(r=o.transform(r,i)),n[o.key]=r}),JSON.stringify(n)}).join(s)}inferColumns(t){if(t.length===0)return[];const e=new Set;return t.forEach(a=>{Object.keys(a).forEach(s=>e.add(s))}),Array.from(e).map(a=>({key:a,header:a.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())}))}escapeCSV(t,e){return t.includes('"')||t.includes(e)||t.includes(`
`)||t.includes("\r")?`"${t.replace(/"/g,'""')}"`:t}formatValue(t){return t==null?"":typeof t=="object"?JSON.stringify(t):String(t)}downloadFile(t,e,a){const s=new Blob([t],{type:a}),i=URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=e,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}};m(R,"instance");let et=R;const $t=et.getInstance(),z=class z{constructor(){m(this,"shortcuts",new Map);m(this,"keyMap",new Map);m(this,"enabled",!0);this.bindGlobalHandler()}static getInstance(){return z.instance||(z.instance=new z),z.instance}register(t){const e=this.normalizeKeys(t.keys);this.keyMap.has(e)&&console.warn(`Shortcut conflict: ${t.keys} is already registered for ${this.keyMap.get(e)}`),this.shortcuts.set(t.id,{...t,enabled:t.enabled!==!1,preventDefault:t.preventDefault!==!1}),this.keyMap.set(e,t.id)}unregister(t){const e=this.shortcuts.get(t);if(e){const a=this.normalizeKeys(e.keys);this.keyMap.delete(a),this.shortcuts.delete(t)}}setEnabled(t,e){const a=this.shortcuts.get(t);a&&(a.enabled=e)}setGlobalEnabled(t){this.enabled=t}getShortcuts(){return Array.from(this.shortcuts.values())}getShortcutsByCategory(t){return this.getShortcuts().filter(e=>e.category===t)}showHelp(){O.emit("modal:opened",{type:"keyboard-help"});const t=this.renderHelpContent();document.dispatchEvent(new CustomEvent("keyboard-help",{detail:{content:t}}))}hideHelp(){O.emit("modal:closed",{type:"keyboard-help"})}bindGlobalHandler(){document.addEventListener("keydown",t=>{if(!this.enabled||this.isInputElement(t.target)&&t.key!=="Escape")return;const e=this.eventToNormalizedKey(t),a=this.keyMap.get(e);if(a){const s=this.shortcuts.get(a);if(s&&s.enabled){s.preventDefault&&t.preventDefault();try{s.handler(t)}catch(i){console.error(`Error in shortcut handler ${a}:`,i)}}}})}isInputElement(t){const e=t.tagName.toLowerCase();return e==="input"||e==="textarea"||e==="select"||t.contentEditable==="true"}normalizeKeys(t){const e=t.toLowerCase().split("+").map(i=>i.trim()),a=[];(e.includes("ctrl")||e.includes("control"))&&a.push("ctrl"),e.includes("alt")&&a.push("alt"),e.includes("shift")&&a.push("shift"),(e.includes("meta")||e.includes("cmd")||e.includes("command"))&&a.push("meta");const s=e.find(i=>!["ctrl","control","alt","shift","meta","cmd","command"].includes(i));return s&&a.push(s),a.join("+")}eventToNormalizedKey(t){const e=[];t.ctrlKey&&e.push("ctrl"),t.altKey&&e.push("alt"),t.shiftKey&&e.push("shift"),t.metaKey&&e.push("meta");let a=t.key.toLowerCase();return a===" "&&(a="space"),a==="arrowup"&&(a="up"),a==="arrowdown"&&(a="down"),a==="arrowleft"&&(a="left"),a==="arrowright"&&(a="right"),["control","alt","shift","meta"].includes(a)||e.push(a),e.join("+")}renderHelpContent(){const t={navigation:{title:"Navigation",icon:"bi-compass"},selection:{title:"Selection",icon:"bi-check2-square"},actions:{title:"Actions",icon:"bi-lightning"},filters:{title:"Filters",icon:"bi-funnel"},general:{title:"General",icon:"bi-gear"}};let e='<div class="keyboard-help">';for(const[a,s]of Object.entries(t)){const i=this.getShortcutsByCategory(a);if(i.length!==0){e+=`
                <div class="keyboard-help-category">
                    <h3><i class="${s.icon}"></i> ${s.title}</h3>
                    <div class="keyboard-help-list">
            `;for(const n of i){const o=this.formatKeysForDisplay(n.keys);e+=`
                    <div class="keyboard-help-item">
                        <span class="keyboard-help-desc">${n.description}</span>
                        <span class="keyboard-help-keys">${o}</span>
                    </div>
                `}e+="</div></div>"}}return e+="</div>",e}formatKeysForDisplay(t){return t.split("+").map(e=>`<kbd>${e.charAt(0).toUpperCase()+e.slice(1)}</kbd>`).join(" + ")}};m(z,"instance");let _=z;function kt(y){const t=_.getInstance();t.register({id:"help",keys:"?",description:"Show keyboard shortcuts",category:"general",handler:()=>t.showHelp()}),t.register({id:"close-modal",keys:"Escape",description:"Close modal / Clear selection",category:"general",handler:()=>{var a;const e=document.querySelector(".ts-modal-overlay.show");if(e){e.classList.remove("show");return}(a=y.onClearSelection)==null||a.call(y)}}),y.onSearch&&(t.register({id:"search",keys:"Ctrl+F",description:"Focus search box",category:"filters",handler:y.onSearch}),t.register({id:"search-alt",keys:"/",description:"Focus search box",category:"filters",handler:y.onSearch})),y.onExport&&t.register({id:"export",keys:"Ctrl+E",description:"Export data",category:"actions",handler:y.onExport}),y.onRefresh&&t.register({id:"refresh",keys:"Ctrl+R",description:"Refresh data",category:"actions",handler:y.onRefresh,preventDefault:!0}),y.onReset&&t.register({id:"reset",keys:"Ctrl+Shift+R",description:"Reset all filters",category:"actions",handler:y.onReset,preventDefault:!0}),y.onShowSchema&&t.register({id:"schema",keys:"Ctrl+I",description:"Show database schema",category:"actions",handler:y.onShowSchema}),y.onSelectAll&&t.register({id:"select-all",keys:"Ctrl+A",description:"Select all rows",category:"selection",handler:y.onSelectAll}),y.onClearSelection&&t.register({id:"clear-selection",keys:"Ctrl+D",description:"Clear selection",category:"selection",handler:y.onClearSelection}),y.onNextPage&&t.register({id:"next-page",keys:"Ctrl+Right",description:"Next page",category:"navigation",handler:y.onNextPage}),y.onPrevPage&&t.register({id:"prev-page",keys:"Ctrl+Left",description:"Previous page",category:"navigation",handler:y.onPrevPage}),y.onFirstPage&&t.register({id:"first-page",keys:"Ctrl+Home",description:"First page",category:"navigation",handler:y.onFirstPage}),y.onLastPage&&t.register({id:"last-page",keys:"Ctrl+End",description:"Last page",category:"navigation",handler:y.onLastPage}),y.onToggleTheme&&t.register({id:"toggle-theme",keys:"Ctrl+Shift+T",description:"Toggle dark/light theme",category:"general",handler:y.onToggleTheme})}_.getInstance();class Mt{constructor(t){m(this,"container");m(this,"configUrl");m(this,"configManager");m(this,"registry");m(this,"client");m(this,"stateManager");m(this,"categoryManager",null);m(this,"sidebar");m(this,"toolbar");m(this,"grid");m(this,"schemaViewer");m(this,"statsViewer");m(this,"theme","light");m(this,"density","normal");m(this,"dom",{});m(this,"columnSchemas",{});if(!t.container)throw new Error("Container required");this.container=t.container,this.configUrl=t.configUrl||null,this.client=t.client||new V,this.registry=P.getInstance(),this.stateManager=new yt,this.stateManager.subscribe(this.onStateChange.bind(this));const e=localStorage.getItem("ts-theme"),a=localStorage.getItem("ts-density");e&&(this.theme=e),a&&(this.density=a)}async init(){try{await this.loadConfiguration();const t=this.configManager.getEnvironment(),e=this.configManager.getApis(),s=this.configManager.getDefaultApiId()||(e.length>0?e[0].id:null);if(s){const n=this.configManager.getApi(s);n&&this.client.updateConfig(n)}else{const n=this.configManager.getApiUrl();n?this.client=new V({environment:t,baseUrl:n}):this.client.setEnvironment(t)}const i=this.configManager.getGlobalSettings();this.stateManager.update({pageSize:i.pageSize||50,showRowNumbers:i.showRowNumbers!==!1}),this.loadStateFromUrl(),this.renderLayout(),this.initComponents()}catch(t){this.container.innerHTML=`<div class="ts-alert ts-alert-danger"><i class="bi bi-x-circle-fill"></i> ${t.message}</div>`}}renderLayout(){this.container.innerHTML=`
            <div class="ts-app" data-theme="${this.theme}" data-density="${this.density}">
                <aside class="ts-sidebar" id="ts-sidebar-container"></aside>
                <main class="ts-main">
                    <header class="ts-toolbar" id="ts-toolbar-container"></header>
                    <div id="ts-alert"></div>

                    <div class="ts-grid-header" id="ts-grid-header" style="display:none">
                        <div class="ts-grid-header-content">
                            <div class="ts-db-info">
                                <i class="bi bi-database"></i>
                                <span id="ts-db-name">Database</span>
                            </div>
                            <div class="ts-table-info">
                                <i class="bi bi-table"></i>
                                <span id="ts-active-table-name">Table</span>
                            </div>
                        </div>
                    </div>
                    <div class="ts-grid-wrapper" style="position:relative">
                        <div class="ts-loading-overlay" id="ts-loading-overlay" style="display:none">
                            <div class="ts-loading-spinner-wrapper">
                                <span class="ts-spinner" style="width:32px;height:32px"></span>
                                <span class="ts-loading-text" style="margin-top:12px;font-size:13px;color:var(--c-text-secondary)">Loading...</span>
                            </div>
                        </div>
                        <div class="ts-grid" id="ts-grid-container"></div>
                    </div>
                    <footer class="ts-footer">
                        <div class="ts-status" id="ts-status">Ready</div>
                        <div class="ts-table-name" id="ts-table-name"></div>
                        <div class="ts-pager" id="ts-pager"></div>
                    </footer>
                </main>
                
                <div class="ts-settings-popup" id="ts-settings-popup" style="top: 70px; right: 24px; bottom: auto;">
                    <div class="ts-settings-header">Settings</div>
                     <div class="ts-settings-body">
                        <div class="ts-settings-row">
                            <div class="ts-settings-label"><i class="bi bi-moon-stars"></i> Theme</div>
                            <div class="ts-switch ${this.theme==="dark"?"on":""}" id="ts-theme-toggle"></div>
                        </div>
                        <div class="ts-settings-row">
                            <div class="ts-settings-label"><i class="bi bi-arrows-angle-expand"></i> Density</div>
                            <div class="ts-density-options">
                                <button class="ts-density-opt ${this.density==="compact"?"active":""}" data-density="compact" title="Compact"><i class="bi bi-list"></i></button>
                                <button class="ts-density-opt ${this.density==="normal"?"active":""}" data-density="normal" title="Normal"><i class="bi bi-list-ul"></i></button>
                                <button class="ts-density-opt ${this.density==="comfortable"?"active":""}" data-density="comfortable" title="Comfortable"><i class="bi bi-card-heading"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,this.dom.status=this.container.querySelector("#ts-status"),this.dom.pager=this.container.querySelector("#ts-pager"),this.dom.alert=this.container.querySelector("#ts-alert"),this.dom.tableName=this.container.querySelector("#ts-table-name"),this.dom.loadingOverlay=this.container.querySelector("#ts-loading-overlay")}initComponents(){this.sidebar=new wt({container:this.container.querySelector("#ts-sidebar-container"),configManager:this.configManager,stateManager:this.stateManager,onApiChange:i=>this.switchApi(i),onLoadData:()=>this.handleLoadData(),onTableChange:i=>this.switchTable(i),onExport:()=>this.exportCsv(),onReset:()=>this.reset(),onShowSchema:i=>this.showDatabaseSchema(i),onShowStats:i=>this.showColumnStatistics(i),onUploadDb:i=>this.handleUploadDb(i)}),this.sidebar.mount(),this.toolbar=new xt({container:this.container.querySelector("#ts-toolbar-container"),onSearch:i=>{const n=i?i.trim():"";this.stateManager.update({searchValue:n})},onRefresh:()=>this.softRefresh(),onTestConnection:async()=>{this.stateManager.update({loading:!0});try{const i=await this.client.testConnection();this.showAlert(`Connection Successful! Service Status: ${i.status}`,"success")}catch(i){this.showAlert(`Connection Failed: ${i.message}`,"danger")}finally{this.stateManager.update({loading:!1})}},onSearchNext:()=>{this.grid&&(this.grid.navigateToNextMatch(),this.toolbar.updateSearchNav())},onSearchPrev:()=>{this.grid&&(this.grid.navigateToPreviousMatch(),this.toolbar.updateSearchNav())},getSearchMatchInfo:()=>this.grid?this.grid.getSearchMatchInfo():{current:0,total:0}}),this.toolbar.mount(),this.initKeyboardShortcuts();const t=this.toolbar.getSettingsButton();t&&t.addEventListener("click",i=>{i.stopPropagation();const n=this.container.querySelector("#ts-settings-popup");n==null||n.classList.toggle("show")});const e=this.container.querySelector("#ts-theme-toggle"),a=this.container.querySelectorAll(".ts-density-opt"),s=this.container.querySelector(".ts-app");e==null||e.addEventListener("click",()=>{this.toggleTheme(),e.classList.toggle("on",this.theme==="dark")}),a.forEach(i=>{i.addEventListener("click",()=>{this.density=i.dataset.density,s==null||s.setAttribute("data-density",this.density),a.forEach(n=>n.classList.remove("active")),i.classList.add("active"),localStorage.setItem("ts-density",this.density)})}),this.grid=new St({container:this.container.querySelector("#ts-grid-container"),stateManager:this.stateManager,onSort:(i,n)=>{this.stateManager.update({sortColumn:i,sortOrder:n,currentPage:0}),this.fetchData()},onFilter:async(i,n)=>{const o=this.stateManager.getState();if(!o.activeTableName)return;const{parseFilterInput:r,normalizeColumnType:l}=await Q(async()=>{const{parseFilterInput:f,normalizeColumnType:h}=await import("./filter-parser-HXU3E1Qm.js");return{parseFilterInput:f,normalizeColumnType:h}},[]),d=l(this.getColumnType(o.activeTableName,i)),c=r(n,d);if(c&&n.trim()){const f=o.advancedFilters||[],h=f.findIndex(b=>b.column===i);h>=0?f[h]={column:i,operator:c.operator,value:c.value,value2:c.value2}:f.push({column:i,operator:c.operator,value:c.value,value2:c.value2});const p={...o.columnFilters};p[i]=n,this.stateManager.update({columnFilters:p,advancedFilters:f.length>0?f:void 0,currentPage:0}),this.sidebar.renderFilterChips()}else{const f={...o.columnFilters};delete f[i];const h=(o.advancedFilters||[]).filter(p=>p.column!==i);this.stateManager.update({columnFilters:f,advancedFilters:h.length>0?h:void 0,currentPage:0}),this.sidebar.renderFilterChips()}this.fetchData()},getColumnType:i=>{const n=this.stateManager.getState();return n.activeTableName?this.getColumnType(n.activeTableName,i):"TEXT"},onRowSelect:()=>this.updateSelectionStatus()}),this.grid.mount(),this.schemaViewer=new Tt({configManager:this.configManager,stateManager:this.stateManager,client:this.client,createModal:this.createModal.bind(this),switchTable:this.switchTable.bind(this),fetchData:this.fetchData.bind(this),getSchemaForTable:async i=>(await this.loadTableSchema(i),this.getSchemaColumns(i)),getConfigColumns:i=>{const n=this.configManager.getTableConfig(i);return(n==null?void 0:n.columns)||[]},getStateColumns:()=>this.stateManager.getState().columns}),this.statsViewer=new Ct({stateManager:this.stateManager,client:this.client,createModal:this.createModal.bind(this),showAlert:this.showAlert.bind(this)})}handleLoadData(){const t=this.stateManager.getState();if(!t.berdlTableId||t.availableTables.length===0){this.loadObject();return}this.fetchData()}initKeyboardShortcuts(){kt({onSearch:()=>this.toolbar.focusSearch(),onExport:()=>this.exportCsv(),onRefresh:()=>this.softRefresh(),onReset:()=>this.reset(),onSelectAll:()=>this.grid.selectAll(),onClearSelection:()=>this.grid.clearSelection(),onToggleTheme:()=>this.toggleTheme(),onShowSchema:()=>{const t=this.stateManager.getState();t.activeTableName&&this.showDatabaseSchema(t.activeTableName)},onNextPage:()=>this.nextPage(),onPrevPage:()=>this.prevPage(),onFirstPage:()=>this.goToPage(0),onLastPage:()=>{const t=this.stateManager.getState(),e=Math.ceil(t.totalCount/t.pageSize);this.goToPage(e-1)}})}async loadObject(){const t=this.sidebar.getToken(),e=this.sidebar.getBerdlId();if(!e||e.trim()===""){this.showAlert("Object ID or database name is required","danger");return}const a=e.trim();if(a==="test/test/test")this.switchApi("test_data");else if(this.switchApi("default"),!V.isLocalDb(a)&&!t){this.showAlert("Auth token required for remote databases","danger");return}this.client.setToken(t||""),this.stateManager.update({berdlTableId:a,loading:!0,error:null});try{const s=await this.client.listTables(a);if(!s)throw new Error("No response from server");const i=s.tables||[];if(i.length===0){const h=`No tables found in database "${a}". The database may be empty or inaccessible.`;this.showAlert(h,"warning"),this.stateManager.update({availableTables:[],activeTableName:null,data:[],columns:[],visibleColumns:new Set,loading:!1}),this.sidebar.updateTables([]);return}let n=this.extractSchemaInfo(s,i);if(Object.keys(n.columns).length===0){const h=await this.fetchSchemaInfo(a);h&&(n=h)}const{getConfigResolver:o}=await Q(async()=>{const{getConfigResolver:h}=await Promise.resolve().then(()=>ft);return{getConfigResolver:h}},void 0),l=await o().resolve(a,{objectType:s.object_type||s.type,schema:n.tables.length>0?n:void 0});if(l.warning&&this.showAlert(l.warning,"warning"),l.config)this.registry.registerDataType(l.config),this.configManager.setCurrentDataType(l.config.id);else{const h=this.registry.detectDataType(s);h&&this.configManager.setCurrentDataType(h)}this.stateManager.update({availableTables:i}),this.sidebar.updateTables(i);const d=this._initialTable,c=d&&i.find(h=>h.name===d)?d:i[0].name,f=`Loaded database "${a}" - ${i.length} table${i.length!==1?"s":""} found`;this.showAlert(f,"success"),await this.switchTable(c)}catch(s){let i=s.message||"Failed to load database";i.includes("404")||i.includes("Not Found")?i=`Database or object "${a}" not found. Please check the ID and try again.`:i.includes("401")||i.includes("Unauthorized")?i.includes("shock-api")||i.includes("Failed to access database")?i=`TableScanner cannot access the database. This usually means:
1. Your token doesn't have permission to access object "${a}"
2. The object exists in a different environment (prod vs appdev)
3. The token is expired or invalid

Original error: ${i}`:i=`Authentication failed. Please check your token and try again.

Details: ${i}`:i.includes("403")||i.includes("Forbidden")?i=`Access denied to database "${a}". Please check your permissions.

Details: ${i}`:i.includes("500")||i.includes("Internal Server Error")?i.includes("shock-api")||i.includes("Failed to access database")?i=`TableScanner service error: Cannot access database from KBase.

This usually means:
 Your token doesn't have permission to access this object
 The object is in a different environment than your token
 Try using a token from the correct environment (appdev vs prod)

Error details: ${i}`:i=`TableScanner service error: ${i}`:i.includes("Network")||i.includes("fetch")?i="Network error: Unable to connect to database service. Please check your connection and try again.":i.includes("Failed to load database")?i=`${i}

This may be a permissions issue. Verify your token has access to object "${a}".`:i=`Failed to load database "${a}": ${i}`,this.showAlert(i,"danger"),this.stateManager.update({availableTables:[],activeTableName:null,data:[],columns:[],visibleColumns:new Set,loading:!1,error:i}),this.sidebar.updateTables([])}finally{this.stateManager.update({loading:!1})}}async switchTable(t){this.stateManager.update({activeTableName:t});const e=this.configManager.getTableConfig(t);this.categoryManager=new vt(e),this.sidebar.setCategoryManager(this.categoryManager),this.sidebar.updateTableInfo(t),this.stateManager.update({currentPage:0,sortColumn:null,columnFilters:{},searchValue:"",data:[],headers:[],columns:[]}),this.toolbar.setSearch(""),this.grid.clearSelection(),this.loadTableDependencies(t).then(()=>{const a=this.stateManager.getState();a.activeTableName===t&&this.stateManager.update({data:[...a.data]})}),await this.fetchData()}async loadTableDependencies(t){var s;const a=this.configManager.getTableConfig(t).columns||[];for(const i of a){if(!i.transform)continue;const n=Array.isArray(i.transform)?i.transform:[i.transform];for(const o of n)if(o.type==="ontology"&&((s=o.options)!=null&&s.lookupTable)){const r=o.options.lookupTable,l=o.options.lookupKey||"id",d=o.options.lookupValue||"name";try{const c=this.stateManager.getState();if(!c.berdlTableId)continue;const f=await this.client.getTableData({berdl_table_id:c.berdlTableId,table_name:r,limit:1e4,offset:0}),h={},p=f.headers,b=p.indexOf(l),g=p.indexOf(d);b!==-1&&g!==-1&&(f.data.forEach(v=>{const w=String(v[b]),S=String(v[g]);h[w]=S}),I.preLoadOntology(h,o.options.ontologyType||"custom"))}catch(c){console.warn(`Failed to load dependency table ${r}`,c)}}}}async fetchData(){var e;const t=this.stateManager.getState();if(!(!t.activeTableName||!t.berdlTableId)){this.stateManager.update({loading:!0});try{const a={},s=new Set(((e=t.advancedFilters)==null?void 0:e.map(r=>r.column))||[]);for(const[r,l]of Object.entries(t.columnFilters))!s.has(r)&&l!==void 0&&l!==null&&l!==""&&(a[r]=l);const i=await this.client.getTableData({berdl_table_id:t.berdlTableId,table_name:t.activeTableName,limit:t.pageSize,offset:t.currentPage*t.pageSize,sort_column:t.sortColumn||void 0,sort_order:t.sortOrder==="asc"?"ASC":"DESC",col_filter:Object.keys(a).length>0?a:void 0,filters:t.advancedFilters,aggregations:t.aggregations,group_by:t.groupBy});this.processColumns(i.headers,t.activeTableName);const n=t.activeTableName;i.column_schema&&i.column_schema.length>0&&n?(this.columnSchemas[n]||(this.columnSchemas[n]={}),(i.column_schema||[]).forEach(l=>{this.columnSchemas[n][l.name]={type:l.type,notnull:l.notnull,pk:l.pk}})):t.activeTableName&&await this.loadTableSchema(t.activeTableName);let o=(i.data||[]).map(r=>{const l={};return i.headers.forEach((d,c)=>{l[d]=r[c]}),l});t.sortColumn&&o.length>0&&(o=this.sortWithNullsLast(o,t.sortColumn,t.sortOrder||"asc")),this.stateManager.update({headers:i.headers,data:o,totalCount:i.total_count||0,queryCached:i.cached||!1,queryTime:i.execution_time_ms}),this.toolbar&&this.grid&&requestAnimationFrame(()=>{setTimeout(()=>{this.toolbar.updateSearchNav()},50)})}catch(a){const s=(a==null?void 0:a.message)||"Failed to load table data";$.error("Failed to fetch table data",a),this.showAlert(s,"danger"),this.stateManager.update({data:[],headers:[],columns:[],error:s})}finally{this.stateManager.update({loading:!1})}}}processColumns(t,e){const s=this.configManager.getTableConfig(e).columns||[],i=[],n=new Set;s.forEach(r=>{i.push({...r,visible:r.visible!==!1,sortable:r.sortable!==!1,filterable:r.filterable!==!1,width:r.width||"auto",categories:r.categories||[]}),n.add(r.column)});const o=r=>{const l=r.toLowerCase(),d=[];return(l.match(/^(id|name|display_name|label)$/)||l.endsWith("_id")||l.endsWith("_name")||l.includes("locus")||l.includes("symbol")||l.includes("alias")||l.includes("contig"))&&d.push("core"),(l.includes("function")||l.includes("product")||l.includes("annotation")||l.includes("subsystem")||l.includes("class")||l.includes("reaction")||l.includes("ec")||l.includes("cog")||l.includes("pfam")||l.includes("tigrfam")||l.includes("go")||l.includes("kegg")||l.includes("note")||l.includes("inference")||l.includes("type"))&&d.push("functional"),(l.includes("uniprot")||l.includes("xref")||l.includes("reference")||l.includes("link")||l.includes("url")||l.includes("dbxref"))&&d.push("external"),(l.includes("sequence")||l.includes("start")||l.includes("stop")||l.includes("length")||l.includes("strand")||l.includes("protein_length")||l.includes("molecular_weight")||l.includes("isoelectric"))&&d.push("sequence"),(l.match(/^(deleted|row_hash|last_synced|created_at|updated_at|sync_.*)$/)||l.includes("hash")||l.includes("sync"))&&d.push("metadata"),(l.match(/^(error|status|report|message|valid|significance)$/)||l.includes("error")||l.includes("valid"))&&d.push("status"),d.length===0&&(l.match(/^[a-z_]*id$/i)||l.endsWith("_id")?d.push("core"):d.push("functional")),d};if(t.forEach(r=>{n.has(r)||i.push({column:r,displayName:r.replace(/_/g," "),visible:!0,sortable:!0,filterable:!0,width:"auto",categories:o(r)})}),this.stateManager.update({columns:i}),this.categoryManager){this.categoryManager.setColumns(i);const r=this.stateManager.getState();if(r.visibleColumns.size===0)this.stateManager.update({visibleColumns:this.categoryManager.getInitialVisibleColumns()});else{const l=new Set(r.visibleColumns),d=new Set(i.map(c=>c.column));l.forEach(c=>{d.has(c)||l.delete(c)}),this.stateManager.update({visibleColumns:l})}}}async loadTableSchema(t){if(!(!t||this.columnSchemas[t]))try{const e=this.stateManager.getState();if(!e.berdlTableId)return;let a=[];try{a=await this.client.getTableSchema(e.berdlTableId,t)}catch(s){$.warn("[TableRenderer] Failed to load schema from ApiClient",s)}a.length>0&&(this.columnSchemas[t]={},a.forEach(s=>{this.columnSchemas[t][s.name]={type:s.type,notnull:!!s.notnull,pk:!!s.pk}}))}catch(e){$.warn("[TableRenderer] Error loading schema:",e)}}getColumnType(t,e){var a,s;return((s=(a=this.columnSchemas[t])==null?void 0:a[e])==null?void 0:s.type)||"TEXT"}getSchemaColumns(t){const e=this.columnSchemas[t];return e?Object.entries(e).map(([a,s])=>({column:a,type:s.type,notnull:s.notnull,pk:s.pk})):[]}switchApi(t){const e=this.configManager.getApi(t);e&&(this.client.updateConfig(e),this.reset())}softRefresh(){this.fetchData()}reset(){this.grid.clearFilterFocus(),this.stateManager.update({sortColumn:null,sortOrder:"asc",searchValue:"",columnFilters:{},currentPage:0}),this.toolbar.setSearch(""),this.grid.clearSelection(),this.sidebar.renderFilterChips(),this.fetchData()}nextPage(){const t=this.stateManager.getState(),e=Math.ceil(t.totalCount/t.pageSize);t.currentPage<e-1&&this.goToPage(t.currentPage+1)}prevPage(){const t=this.stateManager.getState();t.currentPage>0&&this.goToPage(t.currentPage-1)}goToPage(t){t>=0&&(this.stateManager.update({currentPage:t}),this.fetchData())}toggleTheme(){this.theme=this.theme==="light"?"dark":"light",localStorage.setItem("ts-theme",this.theme);const t=this.container.querySelector(".ts-app");t&&t.setAttribute("data-theme",this.theme)}async exportCsv(){const t=this.stateManager.getState();if(t.data.length===0)return;const e=this.grid.getSelection(),s=e.size>0?t.data.filter((i,n)=>e.has(n)):t.data;await $t.export(s,{format:"csv",filename:`export_${t.activeTableName||"data"}_${new Date().toISOString().split("T")[0]}`,columns:t.columns.filter(i=>t.visibleColumns.has(i.column)).map(i=>({key:i.column,header:i.displayName||i.column})),includeHeaders:!0})}onStateChange(t){this.updateStatusBar(t),this.updatePagination(t),this.updateLoadingOverlay(t),this.syncStateToUrl(),t.error&&this.showAlert(t.error,"danger"),this.toolbar&&this.grid&&setTimeout(()=>{this.toolbar.updateSearchNav()},100)}updateLoadingOverlay(t){if(!this.dom.loadingOverlay)return;t.loading&&t.availableTables.length>0?this.dom.loadingOverlay.style.display="flex":this.dom.loadingOverlay.style.display="none"}updateStatusBar(t){var o,r;if(!this.dom.status)return;let e="";const a=[];if(t.queryCached&&a.push(" Cached"),t.queryTime!==void 0&&a.push(`${t.queryTime}ms`),t.totalCount>0){const l=t.currentPage*t.pageSize+1,d=Math.min((t.currentPage+1)*t.pageSize,t.totalCount),c=Math.ceil(t.totalCount/t.pageSize);e=`<div style="display:flex;flex-direction:column;gap:2px">
                <div style="font-size:13px;font-weight:600;color:var(--c-text-primary)">Rows: <strong>${l.toLocaleString()}</strong>  <strong>${d.toLocaleString()}</strong> of <strong>${t.totalCount.toLocaleString()}</strong></div>
                <div style="font-size:11px;color:var(--c-text-muted);display:flex;gap:8px;align-items:center">
                    <span>Page ${t.currentPage+1} of ${c||1}</span>
                    ${a.length>0?`<span style="display:flex;align-items:center;gap:4px">${a.join("  ")}</span>`:""}
                </div>
            </div>`;const f=((r=(o=this.grid)==null?void 0:o.getSelection())==null?void 0:r.size)||0;f>0&&(e+=`<div style="margin-top:4px;font-size:11px"><span class="ts-selection-info">${f} row${f!==1?"s":""} selected</span></div>`)}else e='<div style="font-size:13px">Ready</div>';this.dom.status.innerHTML=e,this.dom.tableName&&(t.activeTableName?this.dom.tableName.innerHTML=`<span style="color:var(--c-text-muted);font-size:13px;font-weight:500">${t.activeTableName}</span>`:this.dom.tableName.innerHTML="");const s=this.container.querySelector("#ts-grid-header"),i=this.container.querySelector("#ts-db-name"),n=this.container.querySelector("#ts-active-table-name");s&&i&&n&&(t.activeTableName&&t.berdlTableId?(s.style.display="block",i.textContent=t.berdlTableId,n.textContent=t.activeTableName):s.style.display="none")}updateSelectionStatus(){const t=this.stateManager.getState();this.updateStatusBar(t)}updatePagination(t){if(!this.dom.pager)return;const e=Math.ceil(t.totalCount/t.pageSize),a=t.currentPage;this.dom.pager.innerHTML=`
            <button class="ts-page-btn" data-page="${a-1}" ${a<=0?"disabled":""}><i class="bi bi-chevron-left"></i></button>
            <span class="ts-page-info">${a+1} / ${e||1}</span>
            <button class="ts-page-btn" data-page="${a+1}" ${a>=e-1?"disabled":""}><i class="bi bi-chevron-right"></i></button>
        `,this.dom.pager.querySelectorAll(".ts-page-btn").forEach(s=>{s.addEventListener("click",()=>{const i=parseInt(s.dataset.page||"0");i>=0&&i<e&&this.goToPage(i)})})}syncStateToUrl(){const t=this.stateManager.getState(),e=new URLSearchParams;t.activeTableName&&e.set("table",t.activeTableName),t.sortColumn&&e.set("sort",`${t.sortColumn}:${t.sortOrder}`),t.currentPage>0&&e.set("page",String(t.currentPage+1));const a=e.toString()?`?${e.toString()}`:window.location.pathname;window.history.replaceState({},"",a)}loadStateFromUrl(){const e=new URLSearchParams(window.location.search).get("table");e&&(this._initialTable=e)}async loadConfiguration(){const t="/config/index.json";try{const a=await fetch(t);if(a.ok){const s=await a.json();if(s.dataTypes){await this.registry.initialize(s),this.configManager=new nt(s);return}}}catch{}let e={};if(this.configUrl)try{const a=await fetch(this.configUrl);a.ok&&(e=await a.json())}catch{}!Object.keys(e).length&&window.DEFAULT_CONFIG&&(e=window.DEFAULT_CONFIG),this.configManager=new nt(e)}showAlert(t,e){if(this.dom.alert){const s=t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>"),n=e==="danger"?8e3:t.length>100?6e3:4e3;this.dom.alert.innerHTML=`<div class="ts-alert ts-alert-${e}">${s}</div>`,setTimeout(()=>{this.dom.alert&&(this.dom.alert.innerHTML="")},n)}}showDatabaseSchema(t){this.schemaViewer.show(t)}isValueEmpty(t){if(t==null)return!0;if(typeof t=="string"){const e=t.trim();if(e===""||e.length===0||e.toLowerCase()==="null"||e.toLowerCase()==="undefined"||e==="-")return!0}return!!(Array.isArray(t)&&t.length===0||typeof t=="number"&&isNaN(t)||typeof t=="object"&&!Array.isArray(t)&&Object.keys(t).length===0)}sortWithNullsLast(t,e,a){return!t||t.length===0||!e||!t.some(i=>e in i)?t:[...t].sort((i,n)=>{const o=i==null?void 0:i[e],r=n==null?void 0:n[e],l=this.isValueEmpty(o),d=this.isValueEmpty(r);if(l&&d)return 0;if(l)return 1;if(d)return-1;let c=0;if(typeof o==="number"&&typeof r==="number"){if(isNaN(o)&&isNaN(r))return 0;if(isNaN(o))return 1;if(isNaN(r))return-1;c=o-r}else if(o instanceof Date&&r instanceof Date)c=o.getTime()-r.getTime();else{const p=String(o??"").trim().toLowerCase(),b=String(r??"").trim().toLowerCase();p<b?c=-1:p>b?c=1:c=0}return a==="desc"?-c:c})}async handleUploadDb(t){try{if(this.stateManager.update({loading:!0,error:null}),!t.name.endsWith(".db")&&!t.name.endsWith(".sqlite")&&!t.name.endsWith(".sqlite3")){this.showAlert("Please select a valid SQLite database file (.db, .sqlite, or .sqlite3)","warning"),this.stateManager.update({loading:!1});return}this.showAlert(`Uploading ${t.name}...`,"info");const a=(await this.client.uploadDatabase(t)).handle;this.sidebar.setBerdlId(a),this.stateManager.update({berdlTableId:a});const i=(await this.client.listTables(a)).tables||[];if(i.length===0){this.showAlert("Database uploaded but contains no tables.","warning"),this.stateManager.update({availableTables:[],loading:!1}),this.sidebar.updateTables([]);return}this.stateManager.update({availableTables:i}),this.sidebar.updateTables(i),await this.switchTable(i[0].name),this.showAlert(`Successfully uploaded and loaded "${t.name}" - ${i.length} table${i.length!==1?"s":""} found`,"success")}catch(e){$.error("Failed to upload database",e),this.showAlert(`Failed to upload: ${e.message}`,"danger"),this.stateManager.update({loading:!1,error:e.message})}finally{this.stateManager.update({loading:!1})}}async showColumnStatistics(t){await this.statsViewer.show(t)}extractSchemaInfo(t,e){const a=e.map(i=>i.name||i),s={};if(t.schemas&&typeof t.schemas=="object")for(const[i,n]of Object.entries(t.schemas))n&&typeof n=="object"&&(s[i]=Object.keys(n));if(Object.keys(s).length===0)for(const i of e){const n=i.name||i;i.columns&&Array.isArray(i.columns)?s[n]=i.columns.map(o=>typeof o=="string"?o:o.name||o.column):i.column_names&&Array.isArray(i.column_names)?s[n]=i.column_names:i.schema&&typeof i.schema=="object"&&(s[n]=Object.keys(i.schema))}return{tables:a,columns:s}}async fetchSchemaInfo(t){try{const e=await this.client.getSchema(t);if(e){const a=Object.keys(e),s={};for(const[i,n]of Object.entries(e))n&&typeof n=="object"&&(s[i]=Object.keys(n));return{tables:a,columns:s}}}catch{}return null}createModal(t,e){var n;const a=document.querySelector(".ts-modal-overlay");a&&a.remove();const s=document.createElement("div");s.className="ts-modal-overlay",s.innerHTML=`
            <div class="ts-modal">
                <div class="ts-modal-header">
                    <span class="ts-modal-title">${t}</span>
                    <button class="ts-modal-close"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="ts-modal-body">${e}</div>
            </div>
        `,document.body.appendChild(s),requestAnimationFrame(()=>s.classList.add("show"));const i=()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),200)};return(n=s.querySelector(".ts-modal-close"))==null||n.addEventListener("click",i),s.addEventListener("click",o=>{o.target===s&&i()}),s}}document.addEventListener("DOMContentLoaded",async()=>{const y=document.querySelector("#app");if(y){const e=new URLSearchParams(window.location.search).get("db");await new Mt({container:y,configUrl:"genome-data.config.json"}).init(),e&&$.info(`Database parameter detected: ${e}`)}else $.error("App container #app not found")});export{st as C};
